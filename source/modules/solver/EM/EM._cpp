#include "engine.hpp"
#include "modules/solver/EM/EM.hpp"
#include "modules/problem/GaussianMixture/GaussianMixture.hpp"
#include "sample/sample.hpp"

namespace korali
{
namespace solver
{

void EM::runGeneration()
{
  Sample sample;

  sample["Module"] = "Problem";
  sample["Operation"] = "Update Mean Sufficient Statistics";
  // sample["Parameters"] = _currentValue;
  sample["Sample Id"] = 0;
  KORALI_START(sample);
  KORALI_WAIT(sample);

  sample["Module"] = "Problem";
  sample["Operation"] = "Update Hyperparameters";
  sample["Sample Id"] = 0;
  KORALI_START(sample);
  KORALI_WAIT(sample);

  auto problem = dynamic_cast<korali::problem::GaussianMixture *>(_k->_problem);
  _hyperparametersDifference = problem->computeHyperparametersDifference();

  problem->computeDataLogLikelihood();
  _dataLoglikelihoodDifference = problem->computeDataLoglikelihoodDifference();

}

void EM::printGenerationBefore()
{
}

void EM::printGenerationAfter()
{
  auto problem = dynamic_cast<korali::problem::GaussianMixture *>(_k->_problem);
  problem->printHyperparameters();
}

} // namespace solver

} // namespace korali
