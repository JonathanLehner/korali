'''
        ! NOTE: !
        This uses two parameters that are BOTH assumed LOG-NORMAL.
        For this, the matlab code was adjusted accordingly before generating the reference llh and prior values.

        DO NOT WORRY IF YOU SEE THE FIRST PARAMETER BEING TRANSFORMED.
'''

import sys
import copy
# import functools
sys.path.append('./_model/normal')
sys.path.append('./_model')
from model import *
from utils import generate_variable, transform_from_z_by_ids

import numpy as np
import korali


def populate_for_test_prior(sample):
  # import pdb
  # pdb.set_trace()
  # if sample["Current Generation"] * 1. == 1:
  if True:
    eta_new = [[
        0.955403225687073, -0.0796186802229635, -2.20872281082742,
        0.189699712274301, 1.64851908218223, -0.666601121797794,
        0.513111356163026, -0.0116305278183840, -1.26559029338445,
        0.528156180556813, -2.24320963352573, 0.857933734459755,
        0.483843621108084, 0.575697475755239, 0.706791124250917,
        -2.44982370977693, -0.701301895827826, -0.0490521663721079,
        0.919774833782153, 1.09390559307292, 0.480971709446874,
        0.298643510632892, -0.0844895787825313, 1.10231870774946,
        1.45668819591121, -0.0577295291673343, -1.97946538217531,
        1.23866512771035, -1.40637656444396, -0.581626265311302,
        0.542185722863804, -2.13718445417425, -0.305197332030139,
        -0.206138940478456, 1.03050936488482, 1.57524321744500,
        -1.44387852400203, -0.393889474761421, 1.27886790134238,
        0.792157377099028, -1.77322688291563, -0.117113349972177,
        1.92100230412726, -1.17960719312903, 0.598705522132116,
        -0.988466018298464, -0.926825038525525, 1.49048999005545,
        0.397413349356479, 0.132636368911159, -1.49684420947353,
        0.544068398357802, -1.04219136911445, -1.16097482997059,
        0.488769906148817, 1.60317316839691, -3.02074421605030,
        -1.02494627343508, -1.07582594850516, -0.0417761276391903,
        -1.72331288829246, -0.442170457296073, 1.16847146662892,
        0.638111104740825, -0.845060249461443, 0.299690048444108,
        -0.807606320444514, -0.813318222073172, -1.82241896874912,
        0.610680050215042, -0.880245218049238, -1.58197882443713,
        -0.977251755839031, -1.43615520812832, -0.113740955406824,
        2.16798666035576, -1.85033706329292, -1.42122141027324,
        0.0686834887943572, -0.258846921647849, -2.23527608488340,
        -0.0723248046700199, 0.527606269935508, -1.43400448938236,
        -1.21233300612792, -1.57228156604838, -0.708132802753860,
        -0.0799158398726321, 0.587928729698604, -3.16317910039754,
        0.121004374413757, -0.795390447065376, 1.54848746390484,
        -0.543478420978740, -1.20407487248466, -1.38895777988169,
        -0.883529665281421, -0.494001645733324, -0.950065841899652,
        -1.54927180553127, -0.500583355702753, -0.135523481501787,
        0.763383914027653, -0.0956479309382953, 0.430616562683736,
        -1.74515347787528, -0.502950052031542, -1.12213310265232,
        -1.51722236513319, -0.526330357338189, -1.49073817835365,
        1.67745247331314, 0.100906477444075, -1.19688964112569,
        -0.802029274251235, -1.00105107593800, -0.759655347485337,
        1.20307627117535, 0.179696838557613, 0.656996193535643,
        -1.22600332415995, -0.362896524957961, 0.756824590306688,
        -0.974604645720560, 0.331173895384510, 0.327168012192084,
        1.24406868922361, -1.69761375618589, -0.246567064175166,
        -2.03390323271431, -0.404600232104005, 0.0527700796961286,
        -0.876362815180458, 1.12020009419528, -0.494029692789321,
        1.77603183817658, -1.65877538407677, 0.124971471609395,
        -0.598746963014193, -0.360594140112559, 0.748477555664273,
        -2.40018751756817, -1.55928177235099, -1.02046934869524,
        -0.0429819903528547, -2.94458853901702, -1.90349265776113,
        1.09073641863796, -2.15205579783866, -2.05261652259339,
        -1.89451096206642, -0.0621824894928506, 0.526013718596372,
        0.477904741134271, 1.53011595492602, -0.338607206009783,
        -0.788013815092879, 1.12010444132979, 1.83409183073823,
        -0.389003116343745, -0.534277884911228, 0.444334363942817,
        -1.62735359498135, 0.339131824790450, -0.635476405403476,
        -1.38270279643769, -1.11132532699592, -1.98355344597986,
        -0.773475255499574, -1.23866401149443, 0.146209292681022,
        -2.46066769766199, 0.423828047150025, -0.367478398877567,
        0.198853048844058, -2.80229933399890, 0.232653617032273,
        0.887638694848748, -0.926000938992777, -0.201630375680025,
        -1.05440249538556, 0.814291656588769, -0.879278600268395,
        -0.130969183868591, 0.0754569653253319, -0.768498297366620,
        -2.17904315142737, 0.171965684645401, -0.399865673289972,
        -1.44145694513908, 2.69242308992491, 0.0859060815823787,
        0.102681416890375, 0.800841295681252, -2.40439722114339,
        -1.51096261669155, 0.450593510640082, 0.179504853210402,
        -2.02659465635932, 1.15455719133914
    ],
               [
                   0.0529933112925620, -0.177890086834182, 0.949221831131022,
                   -2.50880361308089, -0.456589185359234, 0.515246335524849,
                   0.261406324055383, -0.941485770955434, -1.22646737376364,
                   0.792950363598215, -0.532011376808821, -1.00546799475347,
                   -1.10642682179053, 1.79055990344190, 2.16238415597624,
                   0.126440831034675, -0.192239517539275, 1.96300399239219,
                   0.218084852524728, 1.71750379274666, 0.783281930836874,
                   1.60345729812004, 0.655324411572857, -0.537467359670747,
                   0.711050404980253, 1.05407197142897, -1.97969931915418,
                   0.276068253931536, 0.148945429209647, 0.443421912904091,
                   0.391894209432449, -0.702456036560007, 1.49904602128464,
                   -0.697802700025090, -1.58682139990345, -0.320575506600239,
                   -0.659507552410206, 0.771453337957684, -0.820341096137544,
                   -1.17189080414528, 0.654535223497822, 0.933728162671239,
                   0.852969530087173, -0.169877666201260, -0.471672487603141,
                   0.415776190617897, -0.0845394798177241, 1.60394635060288,
                   0.800115123932011, 0.426696052334362, -0.734169112696739,
                   -1.07409163637826, 0.232347012624477, 0.426387557408945,
                   0.668209122528539, -0.0649984242749816, 2.02369088660305,
                   0.224104267123064, 2.22944568045690, 0.254429502250390,
                   1.00006081958913, 1.44702552049463, 0.595832107488619,
                   0.849297440422057, 0.469307182589951, 0.0226875752016302,
                   0.471634326416303, 1.61452633513284, 0.501273171947637,
                   1.39640902818180, -0.189698759604886, 0.642443455300115,
                   1.94343804984731, -0.246921540574881, 1.02308094200517,
                   -0.803611484220362, 0.287609432704476, -1.55133147539103,
                   4.98490752507408e-05, 0.326090358603265, 1.20458671653349,
                   1.91717964312336, 0.778410563541490, -0.246455110143786,
                   0.929789458557716, -0.495902258159414, 0.374494786151301,
                   -0.651553641750281, 0.615062007674962, 0.528265783681366,
                   1.05689959434016, 0.0147406166024418, 1.61476126691229,
                   -0.815854961856177, 0.00116208348351377, 0.894582753187195,
                   -0.142930623055069, 0.581172322675923, -2.19243491996591,
                   1.33723804312817, 0.0660946145174513, -0.491817594931569,
                   0.411490621423374, 0.967953521668745, 0.0303490098505777,
                   1.35109652382173, -1.08637426271259, 0.240265039071171,
                   0.101129606013110, 0.618717644686000, 0.897888425985076,
                   1.02349108136837, -2.11538245061725, 0.647732726433212,
                   1.04956503225249, 0.334273328327356, -0.547412763187907,
                   0.0243149497110560, 0.648679262048621, -0.605661086067383,
                   0.271709764009016, 0.358643412179061, -0.352315122780687,
                   2.29362666140545, 0.301818555261006, 0.399930942955802,
                   0.710302936661393, -0.176830265929232, 1.24402611998341,
                   1.14536171051847, 1.39929399893433, -1.20384997400222,
                   -0.253944683422812, 2.31440289853133, -0.436415217054889,
                   -0.309767634767651, 2.17777870918415, 1.10335073389025,
                   0.342108930771533, 0.441326931727609, -1.39813787581107,
                   0.502433333062860, 0.164404073318729, 0.747734028808123,
                   -0.273046949402907, 1.57630014654608, 0.123568318221231,
                   0.327512120829686, 0.664734120627594, 1.52449750573379,
                   -0.960327091846637, 1.17280564525544, 1.01346429999008,
                   -0.463410644542830, 1.24368028622358, -0.0669465026518546,
                   0.103359722310648, -0.805978094714268, 0.113596996734002,
                   0.956939568099376, -0.467714582451856, -0.869528727142155,
                   1.47895849150403, -0.143267546672041, -0.341532504600556,
                   2.05781063406419, -0.233860042129153, -1.05697274596013,
                   -0.284140954626164, -0.813462364383170, -0.583618751528597,
                   0.192182244870785, 0.361841946052186, 0.853714622304830,
                   0.336213340954240, 0.714376350099612, -0.288256361205697,
                   0.350062757534178, 0.424981415569262, -0.130848151759666,
                   0.858575088792396, 0.535922465110155, -0.315771995009408,
                   0.428622679859396, 0.837862653847684, 2.42646531057117,
                   1.15911590583064, 1.38196183894815, 1.03945813330173,
                   -0.116771141304530, -0.558294284850904, -0.0379812048876393,
                   -0.570009916642186, 0.881669872015693, -0.908745586874325,
                   0.439663109810352, -0.506143772079978, 1.18859467046427,
                   0.401999009965032, 0.699160333644167
               ]]
    par_beta = np.array([2, 2])
    par_omega = np.eye(2)
    eta_new = np.array(eta_new).transpose()
    z_new = eta_new + par_beta
  else:
    z_new = [[
        2.51325987051297, 1.40878421503612, 2.60285829462683, 1.41679674221949,
        2.19339422281162, 0.608110621559598, 1.30971641436775,
        0.113261944312875, 1.22374876989320, 0.772471905969639,
        2.04878321492991, 1.16967809694040, 1.51375514809138, 2.64847830356440,
        2.17033301918522, 0.957647708648255, 1.25358355162573, 1.27833009032476,
        1.78085773323214, 1.54716152312401, 1.15444368975981, 0.976005052854044,
        1.51064856454261, 1.48613675061599, 0.790771169594314, 1.94863440693839,
        0.617871492355904, 1.10414809485583, 1.23010058877642, 1.63368521313434,
        1.76766338828680, 1.03442533106865, 0.871696656313525,
        0.833294147085729, 2.11446186091935, -1.33845438014709,
        1.85050324989325, 2.47630171180961, 0.274251058919018, 2.86076518918998,
        -0.334687260390733, 1.94115729945997, 2.07947794754501,
        0.742994629071168, 2.14933424658033, 2.01839733840656,
        0.926541718379551, 1.92501589774209, 3.47438843981508, 2.52981684619985,
        1.96350087214018, 0.740133230672934, 0.227384321059977,
        0.142617043135189, 2.13262730920509, 0.822593360443003,
        0.729231763471938, -0.0843520784392189, 1.34202896525380,
        1.58280715793526, 1.57224251716733, 0.611527512613638, 1.35984043725581,
        1.82460224784095, 1.49839407801028, 2.65166728312535, 1.24669302414795,
        2.62628680407843, 2.10300411067269, 0.496890404556512,
        0.631362238427303, 1.74224628001510, 2.22765809812510,
        0.900941943919266, 2.33066597055508, 1.54171928914225, 2.91053937231606,
        3.05987998685030, 0.235383755232049, 2.34609060170619, 1.41636042722212,
        0.417182102005065, -0.726803520280551, 2.36359833650414,
        1.19894307856614, 2.91276163321819, 1.93551603854067, 2.25507785013086,
        -0.396217045242703, 0.723502772625009, -0.259754583251015,
        1.11176046856458, 1.51991846739212, 1.47673850649039, 0.652594762011263,
        0.0805819618193975, 0.577009137248607, 0.586897016862015,
        1.08906633812686, 3.29180510155342, 1.08920599867229,
        -0.771901351231853, 0.614240814884296, -0.0352357101948864,
        0.226763958627970, 2.25843940735407, 1.73640978311785,
        0.347669055289415, 1.80958946941294, 1.30103331231147,
        0.305476112783863, 2.05184697499643, 0.801159690641492,
        0.361962287889785, 0.742435526561447, 0.190552267539491,
        1.01171302094188, -0.588206194481937, 0.386529195808807,
        2.30977023414513, 1.01777628915710, 1.87929204532346, 0.936747781911326,
        1.62264498465339, 0.281382225086359, 2.32940963144184,
        0.855948525093110, 1.01275104023632, 2.21059921539855,
        -0.692657298182765, 2.07869464819998, 0.217283876053494,
        1.67586554164771, -0.326575254771714, 1.08584125565231,
        2.04230518164526, 2.39286375437687, 1.42402705995727, 1.80708661502826,
        -0.134788404006370, -0.0656364191624916, 0.267998014424868,
        2.18451340510662, 1.72796867353584, 1.31662030244898, 1.47785415430068,
        2.07609959998850, 1.32771467843924, 1.27396143692859, 1.41401354716107,
        0.696837151711817, 2.15009487273058, 2.86299277198107, 1.65770814134549,
        1.10912349559289, 1.08990051187360, 1.29079196672076, 2.17107126632283,
        -0.826773321604854, 2.39386986615466, 1.20642002550224,
        1.07861432892296, 1.10155741418499, 3.24353121120897, 1.39930132931120,
        0.326738155650915, 1.08478062463738, 1.42829561328548, 2.05447954182443,
        0.412059660812047, 1.11636314032740, 0.489330858103160,
        2.37580721473181, 2.04281004990532, 0.498535178379248, 1.07646348762774,
        0.947150660804499, -0.732337628672538, 2.17020248170294,
        -0.704438559406450, 2.12208396853520, 0.905221897328984,
        0.0618381914566459, 2.60108267482984, 0.334487617377414,
        0.733000167383140, 1.92558323545780, 0.676266018040692,
        2.12638466523486, 2.33432790057397, 2.08455993336175, 1.24328379379015,
        0.775378811096715, 0.522931167993122, 2.35370539329238,
        0.289178820373317, -0.751427483756877, 0.181515858687299,
        -0.139042383004505, 2.90816707004314
    ],
             [
                 3.15654550249467, 1.87942974080956, 3.42828230248396,
                 3.12455905788443, 1.48679688684139, 3.16322165119004,
                 2.15382434656399, 0.603485302999739, 2.97383414311329,
                 4.20570087035203, 2.87369602483750, 1.98840527933309,
                 1.28246383571818, 2.45513753730648, 1.68165552205360,
                 1.43824386448780, 1.80447069458744, 0.741427577309199,
                 2.20170856491113, 2.64446150350310, 2.57311474803492,
                 2.64618444804771, 1.40386875670766, 1.22204031169584,
                 1.15381466290258, 2.07536977270242, 1.67600796746383,
                 2.51823933661647, 4.72697512275044, 1.44059742559655,
                 2.65951221789689, 0.889252435471120, 1.93945220384215,
                 2.90748464594216, 0.334510207964239, 3.37838295980004,
                 3.52109080907736, 2.85221647045767, 1.62646593278021,
                 3.68436457956391, 2.51940132274124, 1.79941483058382,
                 1.09822180771236, 2.08698200876830, 2.63908792339358,
                 3.34525650209449, 1.77749653824292, 2.80405812096062,
                 1.36098415933903, 1.23698566701777, 3.51639517563147,
                 0.980123948684885, 3.25909944272177, 3.58016421339226,
                 1.93816187905809, 1.81555239854107, 1.10215020604482,
                 1.76139355475220, 3.13878648701481, 3.19512478035522,
                 2.24959935492560, 1.00247951991358, 1.97590492644254,
                 1.92138276230329, 1.72159021376872, 1.85945130879489,
                 4.17098756415373, 2.55552295897366, 1.90318883872180,
                 4.35162931458960, 2.60635505218372, 4.43742909359891,
                 3.58420501760915, 0.0577236359782440, 0.720609326535627,
                 0.631700859976854, 1.39104634280501, 2.56254439427270,
                 2.66134171894319, 3.46350381571992, 1.69367728022512,
                 3.41158770444310, 2.54241765000761, 2.29889113592220,
                 2.63323452787539, 3.46536975169648, 2.07124443520586,
                 1.60380910750878, 2.02377870105303, 3.79301314730179,
                 3.08677849515247, 1.34624103530735, 2.78703450182021,
                 1.49068555612177, 3.89606100785423, 0.446853245102538,
                 0.816165787651409, 3.19023962891733, 1.86946594066665,
                 2.77670295591504, 1.86773131023205, 2.54156316731726,
                 0.361115916380795, 1.65243480530229, 2.46107402680687,
                 0.953844912685518, 2.17933856210626, 2.11526041939535,
                 1.77817097063744, 2.43549947421727, 2.39369474177970,
                 1.60391473438345, 2.34082482381483, 3.39393319391305,
                 3.28065267472392, 1.23169174289951, 3.73453931319071,
                 2.90870266152512, 4.07613208128819, 2.13042449089926,
                 2.93382095509915, 4.54514604605463, 2.18089411708676,
                 2.73274231225921, 4.01830696533407, 3.19270870956821,
                 2.56499954909725, 4.37388419338160, 3.11852214005465,
                 0.307954887237347, 2.23344712515267, 1.65560487247985,
                 1.37252905376166, 1.73960263174999, 2.01252750484109,
                 3.58655953215030, 0.891797544143462, 1.48391701408936,
                 0.230826847487253, 3.92026650575602, 0.754358267195087,
                 1.61070035018662, 4.18282272142655, 2.59229377318997,
                 4.08691769615055, 2.37789998275099, 2.06983504454538,
                 1.90207963280200, 0.663279488842439, 2.29930721319103,
                 3.94768533908549, 3.34064468452754, 3.08443784818713,
                 1.01645463205579, 3.60261716941131, 3.69067388265697,
                 3.56945200843155, 1.46805035057192, 3.24855734864987,
                 4.19012431446591, 4.17040588221371, 2.67785811191383,
                 2.16120838918088, 1.16428500906458, 2.50893770778435,
                 2.25098152895650, 2.85516908177054, 2.03960432238619,
                 2.54105190420759, 3.27752103438151, 3.13916589916592,
                 4.07439051379270, 3.24605969704421, 3.08917367800511,
                 2.47653781979238, 1.66706401187562, 2.62682872937353,
                 0.634352513184187, 1.62080499193831, 3.32054311539071,
                 1.79870266547323, 3.25990801032968, 3.10615362546876,
                 2.78089703090125, 2.08046308677928, 3.09961091933158,
                 2.52959960496083, 2.16098572307766, 3.60079042793020,
                 3.67324518590418, 4.98115848377507, 3.39928583698077,
                 2.64631184527559, -0.0774386455212346, 1.28358687535554,
                 1.49863539380702, 1.68216414997698, 3.13323688390174,
                 2.69682002864984, 2.85125371325758
             ]]
    z_new = np.array(z_new).transpose()
    par_beta = np.array([1.39431761023107, 2.39138661700118])
    par_omega = np.diag([np.sqrt(0.95), np.sqrt(0.95)])
  sample["Latent Variables"] = z_new.tolist()
  sample["Mean"] = par_beta.tolist()
  sample["Covariance Cholesky Decomposition"] = par_omega.tolist()


def test_prior(sample):
  ''' Compare to matlab evaluation '''
  all_latent_vars = sample["Latent Variables"]
  mean = sample["Mean"]
  cov = sample["Covariance Cholesky Decomposition"]
  # import pdb
  # pdb.set_trace()
  # if sample["Current Generation"] * 1. == 1:
  if True:
    matlab_priors = [
        -2.29567887375685, -1.85686907502651, -4.72761633629190,
        -5.00291784133169, -3.30092149066232, -2.19279498733628,
        -2.00368533144915, -2.28114242945379, -3.39084757121715,
        -2.29173668150480, -4.49538984890767, -2.71138515700816,
        -2.56701954724158, -3.60664324211176, -4.42560653207782,
        -4.84668881277831, -2.10226725700706, -3.76577246099608,
        -2.28465044028921, -3.91110142873704, -2.26030925064124,
        -3.16800869307812, -2.05617135307243, -2.58986591449229,
        -3.15164365567416, -2.39507727615436, -5.75662336315433,
        -2.64312955612660, -2.83791695735917, -2.10533311908109,
        -2.06165028114136, -4.36837800364119, -3.00801925911316,
        -2.10258800188129, -3.62785291956278, -3.12995699117858,
        -3.09774476828954, -2.21302165189629, -2.99210837795735,
        -2.83829774987569, -3.62425203495636, -2.28065897566290,
        -4.04678050226903, -2.54804284218721, -2.12833868530596,
        -2.41284452141712, -2.27095285425219, -4.23497921944324,
        -2.23693785730508, -1.93770803012718, -3.22765050314552,
        -2.56271869912402, -2.40795105847543, -2.60271151887855,
        -2.18057679270289, -3.12507156792235, -8.44798727807013,
        -2.38824585939496, -4.90179182320182, -1.87111687463730,
        -3.82284154332544, -2.98257585154343, -2.69804780072948,
        -2.40212302855985, -2.30506509483452, -1.88304149201183,
        -2.27521051974739, -3.47196797500622, -3.62411991169487,
        -2.99932121526849, -2.24328569805644, -3.29557236352206,
        -4.20386329035174, -2.89963308092633, -2.36769287582487,
        -4.51085585493503, -3.59111028319737, -4.05112688818833,
        -1.84023577846829, -1.92454539181963, -5.06162123305964,
        -3.67828139709793, -2.28002275716347, -2.89643156485172,
        -3.00500694390545, -3.19687125270092, -2.15872627200462,
        -2.05333141117965, -2.19985779865443, -6.98026044610949,
        -2.40371647198117, -2.15430869093969, -4.34051075390466,
        -2.31837112283679, -2.56277589090283, -3.20261807470627,
        -2.23840398262895, -2.12877651372523, -4.69257505752456,
        -3.93210142211104, -1.96535316344677, -1.96800264677066,
        -2.21391683226713, -2.31091833981120, -1.93105290963758,
        -4.27338830542102, -2.55446096317077, -2.49633206094334,
        -2.99397251764570, -2.16779465086011, -3.35212903736890,
        -3.76856746334183, -4.08038958119415, -2.76392831537264,
        -2.71029592325091, -2.39479802374318, -2.27624555654139,
        -2.56186893193166, -2.06441493580912, -2.23711174115767,
        -2.62633223976389, -1.96803655887235, -2.18633176952577,
        -4.94316580509435, -1.93826236105134, -1.97136890007696,
        -2.86399564907752, -3.29445777047943, -2.64207521857781,
        -4.56218497039310, -2.89873958804547, -2.56389678701749,
        -2.25412690944421, -5.14353158029202, -2.05513885592663,
        -3.46299960529256, -5.58500500690675, -2.45437742175553,
        -2.07564528952553, -2.00027586368516, -3.09538115196467,
        -4.84454675324070, -3.06707123886426, -2.63810900114140,
        -1.87607811044581, -7.41553897446514, -3.65715378011862,
        -2.48636212852611, -4.37448487047811, -5.10654068331531,
        -4.09357702077157, -2.52754693818062, -2.48977722616233,
        -2.05944824994645, -3.78187481133951, -1.89744540349888,
        -2.15370156889603, -2.78999439073233, -3.52627562703319,
        -2.37140544716903, -2.08998196088101, -2.31463368356231,
        -4.25567603775465, -1.90564505866691, -2.09811442317097,
        -4.91110288088148, -2.48274431727296, -4.36371489578988,
        -2.17737709289235, -2.93588184222901, -2.01887106861039,
        -4.88378683318971, -1.99315697014626, -2.26981158139869,
        -1.91416803924444, -6.01948462986551, -1.90648678405622,
        -2.29310025981196, -2.35692053770672, -1.86676509001724,
        -2.76233496909443, -2.31301896170926, -2.27429847127043,
        -1.93831223081587, -2.19173085657374, -5.07703883463966,
        -4.88376643587540, -2.80757242691160, -2.45805995019073,
        -2.88359387847497, -5.61829436823834, -1.84228827979812,
        -2.00560445563187, -2.54722133845364, -5.14134933576215,
        -3.07603290599309, -2.06748508133250, -2.56036670790042,
        -3.97222161900785, -2.74879080651652
    ]
  else:
    matlab_priors = [
        -2.75368898354517, -1.92464120661888, -3.12117495539684,
        -2.06976647699319, -2.55332377869746, -2.42545258730452,
        -1.82005387448326, -4.33273889191084, -1.98044632463670,
        -3.72259866140098, -2.13445092603297, -1.89861370330613,
        -2.44130748796840, -2.61657494283343, -2.36864595205851,
        -2.36508993497818, -1.97830818003985, -3.22648794961932,
        -1.88415799840830, -1.83258806669884, -1.83424935693299,
        -1.91285078800354, -2.30696504324797, -2.51068984374405,
        -2.78440095495691, -2.00086469675464, -2.37323387000985,
        -1.83936796156227, -4.67181582377101, -2.29252952771207,
        -1.89778293404691, -3.04233616777006, -2.03783502216447,
        -2.09242824658830, -4.28624077404921, -6.22984931522903,
        -2.56781371908942, -2.51450679828782, -2.75482205229398,
        -3.79829983176249, -3.36860777597950, -2.12840705709028,
        -2.91380477823819, -2.05862787270623, -2.11890275010214,
        -2.47044864823628, -2.10009709507196, -2.02444611020457,
        -4.62259634088628, -3.16658380792089, -2.62322263656332,
        -3.06006773067500, -2.89956211375636, -3.35497665799522,
        -2.18159107448637, -2.13313833251932, -2.89419940722966,
        -3.14624445974502, -2.08202622891124, -2.14528026929835,
        -1.81382635107188, -3.12438548847875, -1.87806467236171,
        -2.00029350507124, -2.02840436829997, -2.76757502046594,
        -3.46488511387572, -2.59957789483496, -2.17635936498238,
        -4.23286115251315, -2.11727447070024, -4.05360702217961,
        -2.90093751180728, -4.78100611786678, -3.71723903845173,
        -3.42775283434817, -3.52322013833705, -3.26205377998497,
        -2.53184873903622, -2.86832435891128, -2.04304914276147,
        -2.83690169847115, -4.16656546846068, -2.28556300378205,
        -1.83745830866259, -3.60716904810351, -1.99468206432150,
        -2.50299773204842, -3.54508373640091, -3.05739928612441,
        -3.48107044857412, -2.40351420635910, -1.87727473206462,
        -2.21713935371100, -3.26774051205353, -4.68506345009292,
        -3.44411735161459, -2.46558069267650, -1.97899405176218,
        -3.75970348821062, -1.97990375929309, -4.26819302742513,
        -4.27633057435657, -3.14956928568177, -2.50660370068346,
        -3.26723252565856, -1.87184242061923, -2.40327791653006,
        -2.07525963832372, -1.79218793223765, -2.41057384254973,
        -2.34050842014930, -1.97310630491761, -2.87650858804500,
        -2.42644923119400, -3.25708019374972, -2.81313400203567,
        -3.99606615421950, -3.81500733395832, -2.26350731828010,
        -2.01606712866596, -4.35178370935328, -1.92009810902642,
        -1.87535066707215, -3.83158113587802, -2.58474913211024,
        -1.95499573098142, -3.93178887080695, -2.41555310245392,
        -6.36350589883003, -2.04622420001362, -2.80068018621277,
        -2.37465744141935, -3.56884409636254, -1.91221108160123,
        -2.75938702981827, -3.49493208224428, -2.22046994655441,
        -4.33310838726566, -4.24744635992502, -4.31886144886988,
        -2.77504002417437, -3.80429572490482, -1.86641888647036,
        -3.30282719938917, -1.79035232123153, -2.08564803270937,
        -1.91492970639514, -3.36597316930867, -1.79125037546263,
        -3.31739677327310, -2.56147332427187, -3.17465047717430,
        -2.81806405365685, -2.60153910576706, -2.72385596595215,
        -2.52266568010086, -2.55284487894571, -4.76973460922123,
        -4.01530062286530, -3.47090748167667, -1.88223349793032,
        -1.85957879778571, -4.37888340267561, -1.79386961223242,
        -2.39681507759574, -1.95021920364178, -1.85232339701977,
        -2.02774875840056, -2.70767055352855, -2.12154826790298,
        -3.70842752893888, -2.67805109701825, -2.26418862824241,
        -2.21272950494345, -2.11588612968064, -1.92100022935749,
        -5.79175816524924, -2.41594870605519, -4.55927285522761,
        -2.25022489764182, -2.30950168099468, -2.98994865510133,
        -2.63289971079689, -2.42864327486276, -2.28075346814090,
        -1.94518692706826, -2.08589043568911, -2.83846785144893,
        -3.11646837024316, -5.56729576495567, -2.33325327272926,
        -2.02241119785581, -5.39416930285599, -2.91692334353624,
        -2.84886613589702, -4.47459351734034, -2.85038898625762,
        -3.07315347613061, -3.10406689475474
    ]
  all_priors = sample["Log Prior"]

  for indiv in range(len(matlab_priors)):  # 200
    prior_korali = all_priors[indiv]
    prior_matlab = matlab_priors[indiv]
    if not (np.isclose(prior_korali, prior_matlab, rtol=1e-03, atol=1e-08)):
      import pdb
      pdb.set_trace()
      print(f" korali prior: {prior_korali}; matlab prior: {prior_matlab}")
      raise AssertionError(
          "Matlab-calculated Prior differed from Korali-calculated Prior.")


def populate_for_test_llh(sample):
  raise AssertionError("Do not use this function, use populate_for_test_prior. Why use a different function? "
                       "They both need z-values, additional hyperparams won't hurt the llh test.")
  if sample["Current Generation"] * 1. == 1: # * 1.: should raise an error if the value isn't set
    z_1 = [[
        2.29617118400922, 3.20078291754841, 3.09017282673477, 1.64129677465403,
        1.87007236950973, 2.73373752377581, 2.12033157031684, 3.13633128468824,
        1.31322688128078, 2.47168286344277, 2.28834246545593, 3.39185483504681,
        0.654497989838905, 2.00074740619173, 2.05349480757377,
        -0.341905193911678, 3.24809514455416, 4.80923185356508,
        1.76781513822437, 2.28703214689339, 1.53539551010664, 2.38431777671226,
        1.62017247664669, 1.89822177245450, 3.61815114170313, 1.15277011735014,
        1.42411682328718, 1.92408687163145, 1.86752840782227, 3.43930966613682,
        4.03126291502474, 1.02179838994977, 1.35897633200762, 2.52047566951604,
        1.61930000384601, 3.99285194124338, 3.63587024814945, 2.55901889132950,
        2.56363758440702, 1.66160337867572, 2.76364737158536, 3.12744234603730,
        2.14157116726305, 3.92813410297015, 2.67063790955333, 1.88988876300060,
        2.37096225801191, 3.09659469334834, 1.60183689284492, 1.91453744871150,
        4.37328741115302, 1.52607898006474, 2.94634085841825, 2.81816157586699,
        3.58897088443884, 2.52601199721206, -0.465197552662072,
        1.14747205743548, 2.51173541276048, 2.25777491137441, 3.96244739500166,
        3.40631490892524, 2.49683373192458, 2.08283056227552, 0.451522135023551,
        3.86315963313024, 2.13402662181891, 0.453997426173788, 2.43328239619163,
        2.10295421998747, 1.42965390012336, 2.49306215669375, 1.29248678649202,
        0.651974964029148, 0.245698469063801, 1.63619104535263,
        1.37290599437388, 2.44015025271405, 0.497358871090851, 1.79176455565003,
        0.494874540416771, 3.80974082267486, 1.88302743224813, 3.22620898517007,
        2.49494314446408, 2.90859485435771, 0.845781165231419, 3.25755551743135,
        3.45253241673925, -0.0768114851631014, 1.82351199593344,
        1.34791780852425, 2.15653380369264, 1.14977420569265, 2.27904591870816,
        2.59709373050610, 2.24471670780635, 1.88165348892492, 0.710592118054841,
        2.05756364172883, 1.47906711272754, 0.720973108220354, 1.94377276849990,
        1.79031971682780, 2.19210155851939, 2.99233228899097, 2.57624419377870,
        3.30578377155815, 1.27069416813450, 1.13542531242176, 1.90507900859342,
        3.38321391556811, 3.30368137352944, 1.87418781944396, 1.40312621504398,
        0.479353674387140, 2.67184160066350, 2.02284429005612,
        0.822211413746046, 1.66542183590025, 0.170544791392103,
        2.42998959695220, 1.82600653768634, 3.63124241928948, 0.640571978569485,
        2.97050668196924, 2.14363981048730, 2.08260359115828, 2.71666401455796,
        3.19348386200520, 0.928938081253924, 3.31890220931254,
        0.789996858805363, 0.925885098226674, 1.32743991815706,
        2.73646218157545, 0.930039307199717, 2.33471511952614, 2.41188259525515,
        2.15412018753439, 2.55457069767033, 0.827154311543846, 3.00758668596220,
        2.11352028011021, 2.73005086744430, 1.01648821948116, 2.05203155671805,
        2.87759937259473, 3.01414104094213, 1.91565158921320, 0.146468423653789,
        0.903179290140671, 2.21862762752517, 2.79424585072032, 2.46312419493149,
        1.38736997577960, 4.24439981063933, 2.07234760835936, 2.86551439630275,
        1.58430353340430, 0.885061894073759, 2.68525242793293, 3.03767321527948,
        3.82221152843106, 1.47101150692324, 0.372033267004412, 3.61730243170781,
        2.26413674191525, 0.872853814340827, 1.44082414096478, 1.19115484346264,
        3.16100428559655, 2.59210526914654, 2.24274766448453, 2.24047748467937,
        1.17849960115298, 2.99311212621320, 2.34639472451811, 1.73886647263345,
        1.81528709491202, 1.89826500042124, 1.11295685617196, 2.74137709730535,
        3.39220787088793, 4.47390028937627, 2.50391924269087, 1.17751944616943,
        2.20098187064634, 0.992947472490921, 1.38682843976593, 1.34103660915048,
        1.16677067248804, 2.37817929688714, 0.884657403991827, 2.66724135174662,
        2.79533280366610, 3.03749185434765, 1.97956880739732, 2.61895308586923,
        3.80306351071647
    ],
           [
               2.05299331129256, 1.82210991316582, 3.77248256195541,
               -0.508803613080886, 1.54341081464077, 4.43037753693738,
               1.52854591410129, 1.43967150885168, 0.773532626236361,
               2.79295036359821, -0.109940431844270, 1.20060487399405,
               2.56697509289923, 1.99855710113744, 2.62392466625475,
               2.12644083103468, 2.68086779418754, 0.712584086139264,
               2.21808485252473, 0.433432926304198, 2.78328193083687,
               1.68943009127843, 2.65532441157286, 1.46253264032925,
               2.32864340325321, 3.05407197142897, 0.0203006808458179,
               0.132611815412811, 0.167644328974650, 2.84859211514014,
               2.40518726006168, 1.29754396343999, 3.49904602128464,
               2.13779486573036, 0.413178600096547, 0.980854485162359,
               0.614766258974073, 2.95488643030715, 1.39887968062904,
               0.828109195854724, 1.42288969290326, 1.16356947554693,
               2.85296953008717, 2.47733117867658, 2.30232007494690,
               2.41577619061790, 2.04297482930469, 1.05114676994282,
               2.54160836625546, 1.17887174128111, 0.928094951550908,
               0.925908363621740, 2.86955280731327, 2.98105141452526,
               0.241174630860989, 1.85190404243296, 2.25194174617539,
               1.38961537410717, 2.76097981021838, 2.25442950225039,
               1.84716632306262, 1.44258912479082, 2.67701765684745,
               2.84929744042206, 2.46930718258995, 1.76021829551074,
               2.92098545380990, 1.09311862159291, 2.14444060627547,
               3.39640902818180, 1.81030124039511, 1.15616410917400,
               3.94343804984731, 1.75307845942512, 2.44161915586591,
               1.19638851577964, 2.28760943270448, 2.46701809375390,
               2.00456160956192, 2.32609035860327, 3.20458671653349,
               0.595884167929142, 2.20556355545433, 0.00880421057792913,
               2.02840893391827, 3.93051540875233, 2.94113678832666,
               1.99307554869813, 1.66175835272769, 2.52826578368137,
               3.05689959434016, 2.01474061660244, 3.61476126691229,
               1.18414503814382, 0.00224087563347530, 1.25180859168525,
               1.80069597936153, 1.62723992202956, 1.15262883983521,
               3.33723804312817, 0.383682742052146, 1.50818240506843,
               1.03069843299257, 1.52589207947310, 1.33383617480591,
               2.47837468311500, 0.958941866987849, 1.17934090934243,
               2.10112960601311, 3.08398253686458, 0.145472762617027,
               3.79975278578809, 1.12162569442147, 2.64773272643321,
               3.04956503225249, 3.32309337684571, 1.48264103436202,
               2.02431494971106, 1.83763312644646, 1.39433891393262,
               2.27170976400902, 2.35864341217906, 1.64768487721931,
               2.13235992819972, 4.67358177719941, 1.99243392455546,
               2.71030293666139, 1.53746063718710, 1.47212209939989,
               1.65421293309550, 2.56455777373437, 1.19846085599792,
               0.147053214831775, 2.05321601745319, 1.56358478294511,
               2.28000747226616, 2.08460588718095, 2.72911905956814,
               2.90075309564583, 0.674361705468142, 0.475421171514989,
               2.50243333306286, 2.30639142564950, 1.06083953468134,
               3.23740212643015, 2.03301191455503, 2.12356831822123,
               2.27393937955077, 2.75416580828241, 3.52449750573379,
               1.73802423774430, 0.269316492227054, 3.01346429999008,
               1.07226390155370, 3.24368028622358, 1.41051130241411,
               3.49148173478654, 1.19402190528573, 0.887400947246797,
               2.95693956809938, 0.636948411062710, 2.68058496272415,
               2.43782362256573, 1.85673245332796, 1.65846749539944,
               4.05781063406419, 1.62546496457420, 1.80979680254716,
               1.06126758938830, 1.18653763561683, 1.41638124847140,
               3.70952537052387, 1.60958018222896, 1.30993463672020,
               1.55177929807091, 2.71437635009961, 0.684268751716891,
               2.62712209526315, 0.668705156739317, 1.86915184824033,
               0.173103829282035, 2.53592246511016, 2.69286471543664,
               1.31245024491926, 2.31757575644042, 2.16284234012427,
               3.15911590583064, 2.12838805866360, 3.03945813330173,
               1.88322885869547, 1.35170308989575, 1.96201879511236,
               1.80067518122789, 2.88166987201569, 1.94385592909307,
               1.15876113061260, 1.84515616191396, 3.18859467046427,
               1.58509272076415, 1.34138323748860
           ]]
  else:
    z_1 = [[
        2.51325987051297, 1.40878421503612, 2.60285829462683, 1.41679674221949,
        2.19339422281162, 0.608110621559598, 1.30971641436775,
        0.113261944312875, 1.22374876989320, 0.772471905969639,
        2.04878321492991, 1.16967809694040, 1.51375514809138, 2.64847830356440,
        2.17033301918522, 0.957647708648255, 1.25358355162573, 1.27833009032476,
        1.78085773323214, 1.54716152312401, 1.15444368975981, 0.976005052854044,
        1.51064856454261, 1.48613675061599, 0.790771169594314, 1.94863440693839,
        0.617871492355904, 1.10414809485583, 1.23010058877642, 1.63368521313434,
        1.76766338828680, 1.03442533106865, 0.871696656313525,
        0.833294147085729, 2.11446186091935, -1.33845438014709,
        1.85050324989325, 2.47630171180961, 0.274251058919018, 2.86076518918998,
        -0.334687260390733, 1.94115729945997, 2.07947794754501,
        0.742994629071168, 2.14933424658033, 2.01839733840656,
        0.926541718379551, 1.92501589774209, 3.47438843981508, 2.52981684619985,
        1.96350087214018, 0.740133230672934, 0.227384321059977,
        0.142617043135189, 2.13262730920509, 0.822593360443003,
        0.729231763471938, -0.0843520784392189, 1.34202896525380,
        1.58280715793526, 1.57224251716733, 0.611527512613638, 1.35984043725581,
        1.82460224784095, 1.49839407801028, 2.65166728312535, 1.24669302414795,
        2.62628680407843, 2.10300411067269, 0.496890404556512,
        0.631362238427303, 1.74224628001510, 2.22765809812510,
        0.900941943919266, 2.33066597055508, 1.54171928914225, 2.91053937231606,
        3.05987998685030, 0.235383755232049, 2.34609060170619, 1.41636042722212,
        0.417182102005065, -0.726803520280551, 2.36359833650414,
        1.19894307856614, 2.91276163321819, 1.93551603854067, 2.25507785013086,
        -0.396217045242703, 0.723502772625009, -0.259754583251015,
        1.11176046856458, 1.51991846739212, 1.47673850649039, 0.652594762011263,
        0.0805819618193975, 0.577009137248607, 0.586897016862015,
        1.08906633812686, 3.29180510155342, 1.08920599867229,
        -0.771901351231853, 0.614240814884296, -0.0352357101948864,
        0.226763958627970, 2.25843940735407, 1.73640978311785,
        0.347669055289415, 1.80958946941294, 1.30103331231147,
        0.305476112783863, 2.05184697499643, 0.801159690641492,
        0.361962287889785, 0.742435526561447, 0.190552267539491,
        1.01171302094188, -0.588206194481937, 0.386529195808807,
        2.30977023414513, 1.01777628915710, 1.87929204532346, 0.936747781911326,
        1.62264498465339, 0.281382225086359, 2.32940963144184,
        0.855948525093110, 1.01275104023632, 2.21059921539855,
        -0.692657298182765, 2.07869464819998, 0.217283876053494,
        1.67586554164771, -0.326575254771714, 1.08584125565231,
        2.04230518164526, 2.39286375437687, 1.42402705995727, 1.80708661502826,
        -0.134788404006370, -0.0656364191624916, 0.267998014424868,
        2.18451340510662, 1.72796867353584, 1.31662030244898, 1.47785415430068,
        2.07609959998850, 1.32771467843924, 1.27396143692859, 1.41401354716107,
        0.696837151711817, 2.15009487273058, 2.86299277198107, 1.65770814134549,
        1.10912349559289, 1.08990051187360, 1.29079196672076, 2.17107126632283,
        -0.826773321604854, 2.39386986615466, 1.20642002550224,
        1.07861432892296, 1.10155741418499, 3.24353121120897, 1.39930132931120,
        0.326738155650915, 1.08478062463738, 1.42829561328548, 2.05447954182443,
        0.412059660812047, 1.11636314032740, 0.489330858103160,
        2.37580721473181, 2.04281004990532, 0.498535178379248, 1.07646348762774,
        0.947150660804499, -0.732337628672538, 2.17020248170294,
        -0.704438559406450, 2.12208396853520, 0.905221897328984,
        0.0618381914566459, 2.60108267482984, 0.334487617377414,
        0.733000167383140, 1.92558323545780, 0.676266018040692,
        2.12638466523486, 2.33432790057397, 2.08455993336175, 1.24328379379015,
        0.775378811096715, 0.522931167993122, 2.35370539329238,
        0.289178820373317, -0.751427483756877, 0.181515858687299,
        -0.139042383004505, 2.90816707004314
    ],
           [
               3.15654550249467, 1.87942974080956, 3.42828230248396,
               3.12455905788443, 1.48679688684139, 3.16322165119004,
               2.15382434656399, 0.603485302999739, 2.97383414311329,
               4.20570087035203, 2.87369602483750, 1.98840527933309,
               1.28246383571818, 2.45513753730648, 1.68165552205360,
               1.43824386448780, 1.80447069458744, 0.741427577309199,
               2.20170856491113, 2.64446150350310, 2.57311474803492,
               2.64618444804771, 1.40386875670766, 1.22204031169584,
               1.15381466290258, 2.07536977270242, 1.67600796746383,
               2.51823933661647, 4.72697512275044, 1.44059742559655,
               2.65951221789689, 0.889252435471120, 1.93945220384215,
               2.90748464594216, 0.334510207964239, 3.37838295980004,
               3.52109080907736, 2.85221647045767, 1.62646593278021,
               3.68436457956391, 2.51940132274124, 1.79941483058382,
               1.09822180771236, 2.08698200876830, 2.63908792339358,
               3.34525650209449, 1.77749653824292, 2.80405812096062,
               1.36098415933903, 1.23698566701777, 3.51639517563147,
               0.980123948684885, 3.25909944272177, 3.58016421339226,
               1.93816187905809, 1.81555239854107, 1.10215020604482,
               1.76139355475220, 3.13878648701481, 3.19512478035522,
               2.24959935492560, 1.00247951991358, 1.97590492644254,
               1.92138276230329, 1.72159021376872, 1.85945130879489,
               4.17098756415373, 2.55552295897366, 1.90318883872180,
               4.35162931458960, 2.60635505218372, 4.43742909359891,
               3.58420501760915, 0.0577236359782440, 0.720609326535627,
               0.631700859976854, 1.39104634280501, 2.56254439427270,
               2.66134171894319, 3.46350381571992, 1.69367728022512,
               3.41158770444310, 2.54241765000761, 2.29889113592220,
               2.63323452787539, 3.46536975169648, 2.07124443520586,
               1.60380910750878, 2.02377870105303, 3.79301314730179,
               3.08677849515247, 1.34624103530735, 2.78703450182021,
               1.49068555612177, 3.89606100785423, 0.446853245102538,
               0.816165787651409, 3.19023962891733, 1.86946594066665,
               2.77670295591504, 1.86773131023205, 2.54156316731726,
               0.361115916380795, 1.65243480530229, 2.46107402680687,
               0.953844912685518, 2.17933856210626, 2.11526041939535,
               1.77817097063744, 2.43549947421727, 2.39369474177970,
               1.60391473438345, 2.34082482381483, 3.39393319391305,
               3.28065267472392, 1.23169174289951, 3.73453931319071,
               2.90870266152512, 4.07613208128819, 2.13042449089926,
               2.93382095509915, 4.54514604605463, 2.18089411708676,
               2.73274231225921, 4.01830696533407, 3.19270870956821,
               2.56499954909725, 4.37388419338160, 3.11852214005465,
               0.307954887237347, 2.23344712515267, 1.65560487247985,
               1.37252905376166, 1.73960263174999, 2.01252750484109,
               3.58655953215030, 0.891797544143462, 1.48391701408936,
               0.230826847487253, 3.92026650575602, 0.754358267195087,
               1.61070035018662, 4.18282272142655, 2.59229377318997,
               4.08691769615055, 2.37789998275099, 2.06983504454538,
               1.90207963280200, 0.663279488842439, 2.29930721319103,
               3.94768533908549, 3.34064468452754, 3.08443784818713,
               1.01645463205579, 3.60261716941131, 3.69067388265697,
               3.56945200843155, 1.46805035057192, 3.24855734864987,
               4.19012431446591, 4.17040588221371, 2.67785811191383,
               2.16120838918088, 1.16428500906458, 2.50893770778435,
               2.25098152895650, 2.85516908177054, 2.03960432238619,
               2.54105190420759, 3.27752103438151, 3.13916589916592,
               4.07439051379270, 3.24605969704421, 3.08917367800511,
               2.47653781979238, 1.66706401187562, 2.62682872937353,
               0.634352513184187, 1.62080499193831, 3.32054311539071,
               1.79870266547323, 3.25990801032968, 3.10615362546876,
               2.78089703090125, 2.08046308677928, 3.09961091933158,
               2.52959960496083, 2.16098572307766, 3.60079042793020,
               3.67324518590418, 4.98115848377507, 3.39928583698077,
               2.64631184527559, -0.0774386455212346, 1.28358687535554,
               1.49863539380702, 1.68216414997698, 3.13323688390174,
               2.69682002864984, 2.85125371325758
           ]]
  z_1 = np.array(z_1).transpose()
  sample["Latent Variables"] = [z.tolist() for z in z_1]


def test_llh(distrib, sample):
  ''' Compare to matlab evaluation '''
  data = np.array(distrib._p.data)
  all_llhs = sample["logLikelihood"]

  all_latent_vars = sample["Latent Variables"]
  mean = sample["Mean"]
  cov = sample["Covariance Matrix"]

  # if sample["Current Generation"] * 1. == 1:
  if True:
    matlab_llhs = [-983.507250347125, -9.80815523457511, -4.61903045336913, -4274.61778668777, -48240.0798740737, -3.79986145945338, -90.2429973641279, -52.4027006025252, -43.9488927594830, -36.2146448486683, -19.4454869014460, -5319.10486714812, -1221.79776548907, -10.2601010472938, -9.92004443157797, -7.24306754567814, -4.95754934886738, -4.98606067620034, -603.603898531951, -67.3167423574446, -30.7366343678791, -6.54956039380999, -4.53387664311052, -5871.15846686868, -2129.69466572096, -4.59279673116910, -250.769389758360, -2056.98644340623, -6.40661429945493, -3.65403994902410, -81.6672438250702, -23.3478255985873, -4.43406345307331, -6.01543057656354, -35653.4048034962, -27052.7526508734, -18.0556945032313, -3.69176492617432, -21909.1256036999, -5512.49591216775, -4.80666189274995, -4.23335443529679, -10572.9373953647, -7.83804242822394, -576.620949829998, -4.64037407912049, -5.95919886740121, -413.906667380816, -21.1426489315515, -11.3377168844301, -26.2757989559634, -1505.83473052291, -4.51964626562680, -4.71813050001337, -39.1217004785313, -18278.1042909115, -5.02801981860040, -4.62913844637361, -5.19135249278647, -6.81826084212174, -4.67408050874763, -4.38234561583383, -810.315430941472, -51.4627700740218, -4.42904359472591, -49.1111754458622, -3.94403982154010, -4.60696953551195, -5.28165059474212, -18.3598209817689, -6.20415976828542, -4.99614786971996, -4.92170559486742, -9.83532529216490, -4.37976088955270, -786331.673085042, -5.83343488142553, -89.6470677904192, -16.9592357410427, -3.61042666139023, -4.60928771209402, -4.94441669549061, -36.8007866701133, -10.7498253827653, -4.33220190510741, -12.2901925242962, -3.97179021783814, -16.5218020755443, -63.9679002594427, -5.23807409022056, -6.22911537101524, -4.95885388935061, -514.350017276633, -4.13521405921541, -6.24419774559282, -4.52117040592701, -6.78762216032954, -3.65366551520407, -300.584667433558, -4.55357130285224, -3.17600064624440, -11.4159424988878, -206.863161485610, -4.49393029797062, -101.842037460266, -4.61113305233361, -2.72006284214831, -5.10778208507857, -7.59529829109338, -3.70156631535187, -4.64731836327748, -2791.30170122259, -1236.79983537876, -4.61391068023686, -4.09995249851832, -5.14033830635417, -7.10136172210442, -2964.83428450015, -10.5665113842504, -995.772178618097, -5.16290016292465, -3.30558642319093, -932.911866554887, -5.24258862480253, -35.0053837653115, -28.7609522953032, -891.444014210595, -10.0038458928664, -4.20649547575117, -4.65064751739975, -4.32143119666754, -120.555529476461, -6.21136391605885, -26.4844524044014, -2.64747493263318, -60181.6584175687, -5.15672170843342, -6.17698311035417, -3.47139037834640, -3.37627278295508, -7248.29332107443, -5.27821309664527, -6.53086226088965, -4.29636613406372, -12.7730261192148, -4.73498664388052, -7.58750337896104, -1005.98405826835, -4.94072192003343, -4.70513939580601, -37.4686158725245, -4.60182065301637, -24.0864666093944, -321.079554782498, -989.739707051400, -3.07786405763413, -4.69531106958931, -11051.8906483772, -32699.3991721432, -3.87622679342089, -3.04871386578190, -615.610683546681, -4.66676337641707, -87.2134682229437, -4.01639162735220, -5.04449478801850, -7.53435021813913, -58.6756263608777, -5.76837059791931, -20.9295025152960, -74.7213806792989, -7.26921696098054, -50.0792885647504, -3.77342135577398, -18.1536754095516, -5.21322441277892, -69.6733131328159, -403.435938068608, -4.57212811544031, -4.07733983247151, -4.28087090381069, -206.557843090878, -6.73827510145595, -4.59309272126312, -6.02536699717337, -5.35763303766773, -4.51982337470853, -5.99735856337598, -3.95890087747596, -7.86810857109675, -3950095.25619463, -20.0806886469279, -45.0938898658256, -100.534669327727, -40.4639323922613, -5.19484819804794, -309.428659073301, -6.56750531281173, -5.45043353843316, -619.350897028514]
  else:
    matlab_llhs = [-19.0211071564388, -3.30183669973123, -17.5276710036595, -4.09353414839837, -89.1411309559514, -4.49926999193806, -4.04151168107714, -81.6383675843620, -4.10373986657738, -5.17212066051928, -5.66169016585724, -4.87353610833554, -2.41057480113145, -115.711171588898, -49.6196659367404, -11.3950392069986, -5.39121942276126, -19.6606500984559, -3.74026137903394, -3.60069151558290, -4.05383374245847, -4.40044060808225, -3.36542575737708, -4.79010389730524, -21.3996334227326, -7.61772038791190, -9.88952282140960, -4.37589137711763, -5.65330296518066, -2.36378126982001, -3.80920728068150, -25.1897093983879, -6.20925570071030, -4.46711502608525, -485.318564235449, -4.73308884942161, -4.55151695959895, -26.1335330277971, -11.8814829898489, -29.2301843460683, -5.21154038539757, -9.18378150972821, -89.4380048133663, -6.28120432962599, -9.69117619267547, -4.86077631297204, -7.93649787889432, -4.64233400054929, -34074.1473402293, -731.826753449179, -4.67703566955613, -28.0066634794162, -4.49238898715211, -4.70063124535640, -26.3192755403037, -7.52677859099103, -21.7980405280870, -9.90384676532373, -4.18931540350304, -4.11458449443760, -3.22602286471549, -43.4526820107037, -4.12333944148096, -4.26783516363482, -3.44555909469817, -370.949252886179, -5.10490818677000, -86.6389381428214, -22.5455348004526, -5.31937765013499, -4.83951827297361, -5.35932461012987, -5.91694750011507, -159.705429969030, -787.928630856586, -1.64564406398567, -3042.76242914954, -555.110573794792, -4.74821383963292, -7.95180089887640, -3.67394494268850, -4.58325718315886, -5.49851943897683, -41.0504397167373, -3.93909762568369, -53.3308519032878, -6.91441746030871, -87.8923891237932, -8.95031961294863, -4.80907564260435, -4.59674919794104, -12.0233425252509, -3.70959984196041, -3.27114060814966, -4.90007941457868, -116.499430060639, -59.4406266894810, -4.61419414537150, -7.32689978621171, -950.116968259934, -5.88253699286419, -4.99716963383232, -129.090130267013, -12.0502526146475, -4.90903735877097, -328.249804215225, -3.60939935697644, -6.66101642073258, -4.11011598911125, -4.04451363515081, -5.77329861829462, -23.2670956262325, -4.68505445095569, -4.62044832220391, -4.41330442863866, -30.8472661990974, -4.74113982931961, -4.58388249096003, -5.07231777865402, -46.0029447858214, -4.22876383523550, -5.48436939625469, -5.04326595243750, -3.65168611130008, -5.03398697093505, -9.38580331167716, -4.47027590747984, -5.31811344092406, -7.26100325487607, -181.530953732293, -11.0983669656133, -13.9284266132784, -2.76138015427256, -12.3681353967201, -4.75702616379593, -4.98464703964577, -763.507703871141, -3.52663940315344, -61.9222224976809, -4.94993892837132, -61.7092889241442, -12.4272299497527, -5.43710296197253, -3.65166254567078, -5.02252340947455, -3.43583776474394, -13.9818632900796, -4.01291025176569, -19.5037264516938, -3.58531931765872, -4.94906706574617, -5.80318470010162, -85.8642610009923, -2.48123444073827, -4.63797532003396, -4.67282640842189, -4.55607728942540, -81.2942809957391, -4.53770457589401, -6.15405953004547, -5.10843032954661, -4.17395963543197, -4.95961548345239, -19474.2064469479, -3.62947868445443, -6.05371666705141, -4.16539413006259, -3.98271525675764, -7.33521517355678, -4.55356205703444, -4.24781191943056, -5.07356544826403, -10.4366681758387, -5.20522820435359, -5.12002638002833, -8.63583798550689, -4.22890462580574, -91.8722031023137, -52.3140120674312, -4.67484968939127, -31.1685945257908, -4.40820247717601, -4.59144846809253, -51.3825223361349, -7.93485690575866, -4.44481657070464, -5.31011592056311, -5.45962911111977, -5.27771711827087, -6.79046271180533, -5.94080656832709, -4.38681824411399, -4.97674159381647, -230.579243978656, -274.297058238487, -15.4568061436814, -12.4393823636752, -4.55197841069524, -4.81648791862410, -159.788532888445]

  for indiv in range(len(data)):
    llh_korali = all_llhs[indiv]
    llh_matlab = matlab_llhs[indiv]
    if not (np.isclose(llh_korali, llh_matlab, rtol=1e-01, atol=1e-08)):
      import pdb
      pdb.set_trace()
      print(f"korali-llh: {llh_korali}; matlab-llh: {llh_matlab}")
      raise AssertionError(
          "Matlab-calculated LLH differed from Korali-calculated LLH.")


def test_function(distrib, sample):
  all_latent_vars = sample["Latent Variables"]
  mean = sample["Mean"]
  cov = sample["Covariance Matrix"]
  all_llhs = sample["Log Likelihood"]
  logn_ids = [0, 1]
  logitn_ids = []

  import scipy.stats

  data = np.array(distrib._p.data
                 )  # 200 x 1 x 3 -- last dimension contains: (id , x==0 , y)

  for indiv in range(len(data)):
    llh_korali = all_llhs[indiv]
    latents = all_latent_vars[indiv]
    latents = transform_from_z_by_ids(latents, logn_ids, logitn_ids)
    llh = 0
    for point in data[indiv]:
      fx = normalModel(point[1], latents[0])
      llh_point = scipy.stats.norm.logpdf(point[2], fx, scale=latents[1])
      llh += llh_point
    assert np.isclose(llh_korali, llh)


def main():
  # Initialize the distribution
  distrib = NormalConditionalDistribution(datafile="all_data_for_test.txt")

  k = korali.Engine()
  e = korali.Experiment()

  data_vector = [[] for _ in range(distrib._p.nIndividuals)]
  for i in range(distrib._p.nIndividuals):
    data_vector[i] = distrib._p.data[i].tolist()

  e["Problem"]["Type"] = "Bayesian/Latent/HierarchicalLatentCustom"
  # The computational model for the log-likelihood, log[ p(data point | latent) ]

  ## Warning: The i=i below is necessary to capture the current i.
  ## Just writing
  ##   lambda sample, i: logisticModelFunction(sample, x_vals[i])
  ## will capture i by reference and thus not do what is intended.

  func_list = []
  for i in range(distrib._p.nIndividuals):
    func_list.append(lambda sample, i=i: distrib.conditional_p(sample, data_vector[i]) )

  e["Problem"]["Log Likelihood Functions"] = func_list

  e["Problem"]["Latent Space Dimensions"] = distrib._p.nLatentSpaceDimensions

  e["Solver"]["Type"] = "Executor2"
  e["Solver"]["Executions Per Generation"] = 1

  # *** Choose one:
  # test_what = "prior"
  test_what = "llh"
  if test_what == "prior":
    e["Solver"]["Vector Result Names"] = ["Log Prior"]
    e["Solver"]["Function To Execute"] = "Evaluate logPrior"
    e["Solver"][
        "Function To Populate Sample Parameters"] = lambda sample: populate_for_test_prior(
            sample)
    e["Solver"]["Test Function"] = lambda sample: test_prior(sample)
  else:
    assert test_what == "llh"
    e["Solver"]["Vector Result Names"] = ["logLikelihood"]
    e["Solver"]["Function To Execute"] = "Evaluate logLikelihood"
    e["Solver"][
        "Function To Populate Sample Parameters"] = lambda sample: populate_for_test_prior(
            sample)
    e["Solver"]["Test Function"] = lambda sample: test_llh(distrib, sample)

  parmap1 = {}
  parmap2 = {}
  parmap1["Mean"] = [0., 1.]
  # The latents are assumed to already be in z-form, that is, log(latent)
  parmap2["Latent Variables"] = [[0.0, 1.1]] * distrib._p.nIndividuals
  parmap2["Covariance Matrix"] = [[1.0, 0.0], [0., 1.]]
  e["Solver"]["Vector Parameters"] = parmap1
  e["Solver"]["Vector Of Vectors Parameters"] = parmap2
  e["Solver"]["Termination Criteria"]["Max Generations"] = 10
  e["Solver"]["Termination Criteria"]["Max Model Evaluations"] = 100

  e["Distributions"][0]["Name"] = "Uniform 0"
  e["Distributions"][0]["Type"] = "Univariate/Uniform"
  e["Distributions"][0]["Minimum"] = -100
  e["Distributions"][0]["Maximum"] = 100

  e["Distributions"][1]["Name"] = "Uniform 1"
  e["Distributions"][1]["Type"] = "Univariate/Uniform"
  e["Distributions"][1]["Minimum"] = 0
  e["Distributions"][1]["Maximum"] = 100

  e["Distributions"][2]["Name"] = "Uniform 2"
  e["Distributions"][2]["Type"] = "Univariate/Uniform"
  e["Distributions"][2]["Minimum"] = 0.0
  e["Distributions"][2]["Maximum"] = 1.0

  # * Define the variables:
  #   We only define one prototype latent variable vector for individual 0.
  #   The others will be automatically generated by Korali, as well as all hyperparameters.
  if np.isscalar(distrib._p.transf):
    distrib._p.transf = [distrib._p.transf]
  if np.isscalar(distrib._p.err_transf):
    distrib._p.err_transf = [distrib._p.err_transf]
  dimCounter = 0
  distribs = {
      "Normal": "Uniform 0",
      "Log-Normal": "Uniform 1",
      "Logit-Normal": "Uniform 2",
      "Probit-Normal": "Uniform XX"
  }
  for transf in distrib._p.transf:
    generate_variable(
        transf,
        e,
        dimCounter,
        "latent parameter " + str(dimCounter),
        distribs,
        initial=distrib._p.beta[dimCounter])
    dimCounter += 1

  for i, err_transf in enumerate(distrib._p.err_transf):
    generate_variable(
        err_transf,
        e,
        dimCounter,
        "standard deviation " + str(i),
        distribs,
        initial=distrib._p.beta[dimCounter])
    dimCounter += 1

  assert dimCounter == distrib._p.dNormal + distrib._p.dLognormal + distrib._p.dLogitnormal + distrib._p.dProbitnormal

  e["File Output"]["Frequency"] = 1
  e["Console Output"]["Frequency"] = 1
  e["Console Output"]["Verbosity"] = "Normal"

  k.run(e)


if __name__ == '__main__':
  # # ** For debugging, try this: **
  # import sys, trace
  # sys.stdout = sys.stderr
  # tracer = trace.Trace(trace=1, count=0, ignoredirs=["/usr", sys.prefix])
  # tracer.runfunc(main)
  # # ** Else: **
  main()
