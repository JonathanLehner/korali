import sys
import copy
sys.path.append('./_model/normal')
sys.path.append('./_model')
from model import *
from utils import generate_variable, transform_from_z_by_ids

import numpy as np
import korali


def populate_for_test_prior(sample):
  if sample["Current Generation"] == 1:
    eta_new = [[
        0.955403225687073, -0.0796186802229635, -2.20872281082742,
        0.189699712274301, 1.64851908218223, -0.666601121797794,
        0.513111356163026, -0.0116305278183840, -1.26559029338445,
        0.528156180556813, -2.24320963352573, 0.857933734459755,
        0.483843621108084, 0.575697475755239, 0.706791124250917,
        -2.44982370977693, -0.701301895827826, -0.0490521663721079,
        0.919774833782153, 1.09390559307292, 0.480971709446874,
        0.298643510632892, -0.0844895787825313, 1.10231870774946,
        1.45668819591121, -0.0577295291673343, -1.97946538217531,
        1.23866512771035, -1.40637656444396, -0.581626265311302,
        0.542185722863804, -2.13718445417425, -0.305197332030139,
        -0.206138940478456, 1.03050936488482, 1.57524321744500,
        -1.44387852400203, -0.393889474761421, 1.27886790134238,
        0.792157377099028, -1.77322688291563, -0.117113349972177,
        1.92100230412726, -1.17960719312903, 0.598705522132116,
        -0.988466018298464, -0.926825038525525, 1.49048999005545,
        0.397413349356479, 0.132636368911159, -1.49684420947353,
        0.544068398357802, -1.04219136911445, -1.16097482997059,
        0.488769906148817, 1.60317316839691, -3.02074421605030,
        -1.02494627343508, -1.07582594850516, -0.0417761276391903,
        -1.72331288829246, -0.442170457296073, 1.16847146662892,
        0.638111104740825, -0.845060249461443, 0.299690048444108,
        -0.807606320444514, -0.813318222073172, -1.82241896874912,
        0.610680050215042, -0.880245218049238, -1.58197882443713,
        -0.977251755839031, -1.43615520812832, -0.113740955406824,
        2.16798666035576, -1.85033706329292, -1.42122141027324,
        0.0686834887943572, -0.258846921647849, -2.23527608488340,
        -0.0723248046700199, 0.527606269935508, -1.43400448938236,
        -1.21233300612792, -1.57228156604838, -0.708132802753860,
        -0.0799158398726321, 0.587928729698604, -3.16317910039754,
        0.121004374413757, -0.795390447065376, 1.54848746390484,
        -0.543478420978740, -1.20407487248466, -1.38895777988169,
        -0.883529665281421, -0.494001645733324, -0.950065841899652,
        -1.54927180553127, -0.500583355702753, -0.135523481501787,
        0.763383914027653, -0.0956479309382953, 0.430616562683736,
        -1.74515347787528, -0.502950052031542, -1.12213310265232,
        -1.51722236513319, -0.526330357338189, -1.49073817835365,
        1.67745247331314, 0.100906477444075, -1.19688964112569,
        -0.802029274251235, -1.00105107593800, -0.759655347485337,
        1.20307627117535, 0.179696838557613, 0.656996193535643,
        -1.22600332415995, -0.362896524957961, 0.756824590306688,
        -0.974604645720560, 0.331173895384510, 0.327168012192084,
        1.24406868922361, -1.69761375618589, -0.246567064175166,
        -2.03390323271431, -0.404600232104005, 0.0527700796961286,
        -0.876362815180458, 1.12020009419528, -0.494029692789321,
        1.77603183817658, -1.65877538407677, 0.124971471609395,
        -0.598746963014193, -0.360594140112559, 0.748477555664273,
        -2.40018751756817, -1.55928177235099, -1.02046934869524,
        -0.0429819903528547, -2.94458853901702, -1.90349265776113,
        1.09073641863796, -2.15205579783866, -2.05261652259339,
        -1.89451096206642, -0.0621824894928506, 0.526013718596372,
        0.477904741134271, 1.53011595492602, -0.338607206009783,
        -0.788013815092879, 1.12010444132979, 1.83409183073823,
        -0.389003116343745, -0.534277884911228, 0.444334363942817,
        -1.62735359498135, 0.339131824790450, -0.635476405403476,
        -1.38270279643769, -1.11132532699592, -1.98355344597986,
        -0.773475255499574, -1.23866401149443, 0.146209292681022,
        -2.46066769766199, 0.423828047150025, -0.367478398877567,
        0.198853048844058, -2.80229933399890, 0.232653617032273,
        0.887638694848748, -0.926000938992777, -0.201630375680025,
        -1.05440249538556, 0.814291656588769, -0.879278600268395,
        -0.130969183868591, 0.0754569653253319, -0.768498297366620,
        -2.17904315142737, 0.171965684645401, -0.399865673289972,
        -1.44145694513908, 2.69242308992491, 0.0859060815823787,
        0.102681416890375, 0.800841295681252, -2.40439722114339,
        -1.51096261669155, 0.450593510640082, 0.179504853210402,
        -2.02659465635932, 1.15455719133914
    ],
               [
                   0.0529933112925620, -0.177890086834182, 0.949221831131022,
                   -2.50880361308089, -0.456589185359234, 0.515246335524849,
                   0.261406324055383, -0.941485770955434, -1.22646737376364,
                   0.792950363598215, -0.532011376808821, -1.00546799475347,
                   -1.10642682179053, 1.79055990344190, 2.16238415597624,
                   0.126440831034675, -0.192239517539275, 1.96300399239219,
                   0.218084852524728, 1.71750379274666, 0.783281930836874,
                   1.60345729812004, 0.655324411572857, -0.537467359670747,
                   0.711050404980253, 1.05407197142897, -1.97969931915418,
                   0.276068253931536, 0.148945429209647, 0.443421912904091,
                   0.391894209432449, -0.702456036560007, 1.49904602128464,
                   -0.697802700025090, -1.58682139990345, -0.320575506600239,
                   -0.659507552410206, 0.771453337957684, -0.820341096137544,
                   -1.17189080414528, 0.654535223497822, 0.933728162671239,
                   0.852969530087173, -0.169877666201260, -0.471672487603141,
                   0.415776190617897, -0.0845394798177241, 1.60394635060288,
                   0.800115123932011, 0.426696052334362, -0.734169112696739,
                   -1.07409163637826, 0.232347012624477, 0.426387557408945,
                   0.668209122528539, -0.0649984242749816, 2.02369088660305,
                   0.224104267123064, 2.22944568045690, 0.254429502250390,
                   1.00006081958913, 1.44702552049463, 0.595832107488619,
                   0.849297440422057, 0.469307182589951, 0.0226875752016302,
                   0.471634326416303, 1.61452633513284, 0.501273171947637,
                   1.39640902818180, -0.189698759604886, 0.642443455300115,
                   1.94343804984731, -0.246921540574881, 1.02308094200517,
                   -0.803611484220362, 0.287609432704476, -1.55133147539103,
                   4.98490752507408e-05, 0.326090358603265, 1.20458671653349,
                   1.91717964312336, 0.778410563541490, -0.246455110143786,
                   0.929789458557716, -0.495902258159414, 0.374494786151301,
                   -0.651553641750281, 0.615062007674962, 0.528265783681366,
                   1.05689959434016, 0.0147406166024418, 1.61476126691229,
                   -0.815854961856177, 0.00116208348351377, 0.894582753187195,
                   -0.142930623055069, 0.581172322675923, -2.19243491996591,
                   1.33723804312817, 0.0660946145174513, -0.491817594931569,
                   0.411490621423374, 0.967953521668745, 0.0303490098505777,
                   1.35109652382173, -1.08637426271259, 0.240265039071171,
                   0.101129606013110, 0.618717644686000, 0.897888425985076,
                   1.02349108136837, -2.11538245061725, 0.647732726433212,
                   1.04956503225249, 0.334273328327356, -0.547412763187907,
                   0.0243149497110560, 0.648679262048621, -0.605661086067383,
                   0.271709764009016, 0.358643412179061, -0.352315122780687,
                   2.29362666140545, 0.301818555261006, 0.399930942955802,
                   0.710302936661393, -0.176830265929232, 1.24402611998341,
                   1.14536171051847, 1.39929399893433, -1.20384997400222,
                   -0.253944683422812, 2.31440289853133, -0.436415217054889,
                   -0.309767634767651, 2.17777870918415, 1.10335073389025,
                   0.342108930771533, 0.441326931727609, -1.39813787581107,
                   0.502433333062860, 0.164404073318729, 0.747734028808123,
                   -0.273046949402907, 1.57630014654608, 0.123568318221231,
                   0.327512120829686, 0.664734120627594, 1.52449750573379,
                   -0.960327091846637, 1.17280564525544, 1.01346429999008,
                   -0.463410644542830, 1.24368028622358, -0.0669465026518546,
                   0.103359722310648, -0.805978094714268, 0.113596996734002,
                   0.956939568099376, -0.467714582451856, -0.869528727142155,
                   1.47895849150403, -0.143267546672041, -0.341532504600556,
                   2.05781063406419, -0.233860042129153, -1.05697274596013,
                   -0.284140954626164, -0.813462364383170, -0.583618751528597,
                   0.192182244870785, 0.361841946052186, 0.853714622304830,
                   0.336213340954240, 0.714376350099612, -0.288256361205697,
                   0.350062757534178, 0.424981415569262, -0.130848151759666,
                   0.858575088792396, 0.535922465110155, -0.315771995009408,
                   0.428622679859396, 0.837862653847684, 2.42646531057117,
                   1.15911590583064, 1.38196183894815, 1.03945813330173,
                   -0.116771141304530, -0.558294284850904, -0.0379812048876393,
                   -0.570009916642186, 0.881669872015693, -0.908745586874325,
                   0.439663109810352, -0.506143772079978, 1.18859467046427,
                   0.401999009965032, 0.699160333644167
               ]]
    par_beta = np.array([2, 2])
    par_omega = np.eye(2)
    eta_new = np.array(eta_new).transpose()
    z_new = eta_new + par_beta
  else:
    z_new = [[
        2.51325987051297, 1.40878421503612, 2.60285829462683, 1.41679674221949,
        2.19339422281162, 0.608110621559598, 1.30971641436775,
        0.113261944312875, 1.22374876989320, 0.772471905969639,
        2.04878321492991, 1.16967809694040, 1.51375514809138, 2.64847830356440,
        2.17033301918522, 0.957647708648255, 1.25358355162573, 1.27833009032476,
        1.78085773323214, 1.54716152312401, 1.15444368975981, 0.976005052854044,
        1.51064856454261, 1.48613675061599, 0.790771169594314, 1.94863440693839,
        0.617871492355904, 1.10414809485583, 1.23010058877642, 1.63368521313434,
        1.76766338828680, 1.03442533106865, 0.871696656313525,
        0.833294147085729, 2.11446186091935, -1.33845438014709,
        1.85050324989325, 2.47630171180961, 0.274251058919018, 2.86076518918998,
        -0.334687260390733, 1.94115729945997, 2.07947794754501,
        0.742994629071168, 2.14933424658033, 2.01839733840656,
        0.926541718379551, 1.92501589774209, 3.47438843981508, 2.52981684619985,
        1.96350087214018, 0.740133230672934, 0.227384321059977,
        0.142617043135189, 2.13262730920509, 0.822593360443003,
        0.729231763471938, -0.0843520784392189, 1.34202896525380,
        1.58280715793526, 1.57224251716733, 0.611527512613638, 1.35984043725581,
        1.82460224784095, 1.49839407801028, 2.65166728312535, 1.24669302414795,
        2.62628680407843, 2.10300411067269, 0.496890404556512,
        0.631362238427303, 1.74224628001510, 2.22765809812510,
        0.900941943919266, 2.33066597055508, 1.54171928914225, 2.91053937231606,
        3.05987998685030, 0.235383755232049, 2.34609060170619, 1.41636042722212,
        0.417182102005065, -0.726803520280551, 2.36359833650414,
        1.19894307856614, 2.91276163321819, 1.93551603854067, 2.25507785013086,
        -0.396217045242703, 0.723502772625009, -0.259754583251015,
        1.11176046856458, 1.51991846739212, 1.47673850649039, 0.652594762011263,
        0.0805819618193975, 0.577009137248607, 0.586897016862015,
        1.08906633812686, 3.29180510155342, 1.08920599867229,
        -0.771901351231853, 0.614240814884296, -0.0352357101948864,
        0.226763958627970, 2.25843940735407, 1.73640978311785,
        0.347669055289415, 1.80958946941294, 1.30103331231147,
        0.305476112783863, 2.05184697499643, 0.801159690641492,
        0.361962287889785, 0.742435526561447, 0.190552267539491,
        1.01171302094188, -0.588206194481937, 0.386529195808807,
        2.30977023414513, 1.01777628915710, 1.87929204532346, 0.936747781911326,
        1.62264498465339, 0.281382225086359, 2.32940963144184,
        0.855948525093110, 1.01275104023632, 2.21059921539855,
        -0.692657298182765, 2.07869464819998, 0.217283876053494,
        1.67586554164771, -0.326575254771714, 1.08584125565231,
        2.04230518164526, 2.39286375437687, 1.42402705995727, 1.80708661502826,
        -0.134788404006370, -0.0656364191624916, 0.267998014424868,
        2.18451340510662, 1.72796867353584, 1.31662030244898, 1.47785415430068,
        2.07609959998850, 1.32771467843924, 1.27396143692859, 1.41401354716107,
        0.696837151711817, 2.15009487273058, 2.86299277198107, 1.65770814134549,
        1.10912349559289, 1.08990051187360, 1.29079196672076, 2.17107126632283,
        -0.826773321604854, 2.39386986615466, 1.20642002550224,
        1.07861432892296, 1.10155741418499, 3.24353121120897, 1.39930132931120,
        0.326738155650915, 1.08478062463738, 1.42829561328548, 2.05447954182443,
        0.412059660812047, 1.11636314032740, 0.489330858103160,
        2.37580721473181, 2.04281004990532, 0.498535178379248, 1.07646348762774,
        0.947150660804499, -0.732337628672538, 2.17020248170294,
        -0.704438559406450, 2.12208396853520, 0.905221897328984,
        0.0618381914566459, 2.60108267482984, 0.334487617377414,
        0.733000167383140, 1.92558323545780, 0.676266018040692,
        2.12638466523486, 2.33432790057397, 2.08455993336175, 1.24328379379015,
        0.775378811096715, 0.522931167993122, 2.35370539329238,
        0.289178820373317, -0.751427483756877, 0.181515858687299,
        -0.139042383004505, 2.90816707004314
    ],
             [
                 3.15654550249467, 1.87942974080956, 3.42828230248396,
                 3.12455905788443, 1.48679688684139, 3.16322165119004,
                 2.15382434656399, 0.603485302999739, 2.97383414311329,
                 4.20570087035203, 2.87369602483750, 1.98840527933309,
                 1.28246383571818, 2.45513753730648, 1.68165552205360,
                 1.43824386448780, 1.80447069458744, 0.741427577309199,
                 2.20170856491113, 2.64446150350310, 2.57311474803492,
                 2.64618444804771, 1.40386875670766, 1.22204031169584,
                 1.15381466290258, 2.07536977270242, 1.67600796746383,
                 2.51823933661647, 4.72697512275044, 1.44059742559655,
                 2.65951221789689, 0.889252435471120, 1.93945220384215,
                 2.90748464594216, 0.334510207964239, 3.37838295980004,
                 3.52109080907736, 2.85221647045767, 1.62646593278021,
                 3.68436457956391, 2.51940132274124, 1.79941483058382,
                 1.09822180771236, 2.08698200876830, 2.63908792339358,
                 3.34525650209449, 1.77749653824292, 2.80405812096062,
                 1.36098415933903, 1.23698566701777, 3.51639517563147,
                 0.980123948684885, 3.25909944272177, 3.58016421339226,
                 1.93816187905809, 1.81555239854107, 1.10215020604482,
                 1.76139355475220, 3.13878648701481, 3.19512478035522,
                 2.24959935492560, 1.00247951991358, 1.97590492644254,
                 1.92138276230329, 1.72159021376872, 1.85945130879489,
                 4.17098756415373, 2.55552295897366, 1.90318883872180,
                 4.35162931458960, 2.60635505218372, 4.43742909359891,
                 3.58420501760915, 0.0577236359782440, 0.720609326535627,
                 0.631700859976854, 1.39104634280501, 2.56254439427270,
                 2.66134171894319, 3.46350381571992, 1.69367728022512,
                 3.41158770444310, 2.54241765000761, 2.29889113592220,
                 2.63323452787539, 3.46536975169648, 2.07124443520586,
                 1.60380910750878, 2.02377870105303, 3.79301314730179,
                 3.08677849515247, 1.34624103530735, 2.78703450182021,
                 1.49068555612177, 3.89606100785423, 0.446853245102538,
                 0.816165787651409, 3.19023962891733, 1.86946594066665,
                 2.77670295591504, 1.86773131023205, 2.54156316731726,
                 0.361115916380795, 1.65243480530229, 2.46107402680687,
                 0.953844912685518, 2.17933856210626, 2.11526041939535,
                 1.77817097063744, 2.43549947421727, 2.39369474177970,
                 1.60391473438345, 2.34082482381483, 3.39393319391305,
                 3.28065267472392, 1.23169174289951, 3.73453931319071,
                 2.90870266152512, 4.07613208128819, 2.13042449089926,
                 2.93382095509915, 4.54514604605463, 2.18089411708676,
                 2.73274231225921, 4.01830696533407, 3.19270870956821,
                 2.56499954909725, 4.37388419338160, 3.11852214005465,
                 0.307954887237347, 2.23344712515267, 1.65560487247985,
                 1.37252905376166, 1.73960263174999, 2.01252750484109,
                 3.58655953215030, 0.891797544143462, 1.48391701408936,
                 0.230826847487253, 3.92026650575602, 0.754358267195087,
                 1.61070035018662, 4.18282272142655, 2.59229377318997,
                 4.08691769615055, 2.37789998275099, 2.06983504454538,
                 1.90207963280200, 0.663279488842439, 2.29930721319103,
                 3.94768533908549, 3.34064468452754, 3.08443784818713,
                 1.01645463205579, 3.60261716941131, 3.69067388265697,
                 3.56945200843155, 1.46805035057192, 3.24855734864987,
                 4.19012431446591, 4.17040588221371, 2.67785811191383,
                 2.16120838918088, 1.16428500906458, 2.50893770778435,
                 2.25098152895650, 2.85516908177054, 2.03960432238619,
                 2.54105190420759, 3.27752103438151, 3.13916589916592,
                 4.07439051379270, 3.24605969704421, 3.08917367800511,
                 2.47653781979238, 1.66706401187562, 2.62682872937353,
                 0.634352513184187, 1.62080499193831, 3.32054311539071,
                 1.79870266547323, 3.25990801032968, 3.10615362546876,
                 2.78089703090125, 2.08046308677928, 3.09961091933158,
                 2.52959960496083, 2.16098572307766, 3.60079042793020,
                 3.67324518590418, 4.98115848377507, 3.39928583698077,
                 2.64631184527559, -0.0774386455212346, 1.28358687535554,
                 1.49863539380702, 1.68216414997698, 3.13323688390174,
                 2.69682002864984, 2.85125371325758
             ]]
    z_new = np.array(z_new).transpose()
    par_beta = np.array([1.39431761023107, 2.39138661700118])
    par_omega = np.diag([np.sqrt(0.95), np.sqrt(0.95)])
  sample["Latent Variables"] = z_new.tolist()
  sample["Mean"] = par_beta.tolist()
  sample["Covariance Cholesky Decomposition"] = par_omega.tolist()


def test_prior(sample):
  ''' Compare to matlab evaluation '''
  all_latent_vars = sample["Latent Variables"]
  mean = sample["Mean"]
  cov = sample["Covariance Cholesky Decomposition"]

  if sample["Current Generation"] == 1:
    matlab_priors = [
        -2.29567887375685, -1.85686907502651, -4.72761633629190,
        -5.00291784133169, -3.30092149066232, -2.19279498733628,
        -2.00368533144915, -2.28114242945379, -3.39084757121715,
        -2.29173668150480, -4.49538984890767, -2.71138515700816,
        -2.56701954724158, -3.60664324211176, -4.42560653207782,
        -4.84668881277831, -2.10226725700706, -3.76577246099608,
        -2.28465044028921, -3.91110142873704, -2.26030925064124,
        -3.16800869307812, -2.05617135307243, -2.58986591449229,
        -3.15164365567416, -2.39507727615436, -5.75662336315433,
        -2.64312955612660, -2.83791695735917, -2.10533311908109,
        -2.06165028114136, -4.36837800364119, -3.00801925911316,
        -2.10258800188129, -3.62785291956278, -3.12995699117858,
        -3.09774476828954, -2.21302165189629, -2.99210837795735,
        -2.83829774987569, -3.62425203495636, -2.28065897566290,
        -4.04678050226903, -2.54804284218721, -2.12833868530596,
        -2.41284452141712, -2.27095285425219, -4.23497921944324,
        -2.23693785730508, -1.93770803012718, -3.22765050314552,
        -2.56271869912402, -2.40795105847543, -2.60271151887855,
        -2.18057679270289, -3.12507156792235, -8.44798727807013,
        -2.38824585939496, -4.90179182320182, -1.87111687463730,
        -3.82284154332544, -2.98257585154343, -2.69804780072948,
        -2.40212302855985, -2.30506509483452, -1.88304149201183,
        -2.27521051974739, -3.47196797500622, -3.62411991169487,
        -2.99932121526849, -2.24328569805644, -3.29557236352206,
        -4.20386329035174, -2.89963308092633, -2.36769287582487,
        -4.51085585493503, -3.59111028319737, -4.05112688818833,
        -1.84023577846829, -1.92454539181963, -5.06162123305964,
        -3.67828139709793, -2.28002275716347, -2.89643156485172,
        -3.00500694390545, -3.19687125270092, -2.15872627200462,
        -2.05333141117965, -2.19985779865443, -6.98026044610949,
        -2.40371647198117, -2.15430869093969, -4.34051075390466,
        -2.31837112283679, -2.56277589090283, -3.20261807470627,
        -2.23840398262895, -2.12877651372523, -4.69257505752456,
        -3.93210142211104, -1.96535316344677, -1.96800264677066,
        -2.21391683226713, -2.31091833981120, -1.93105290963758,
        -4.27338830542102, -2.55446096317077, -2.49633206094334,
        -2.99397251764570, -2.16779465086011, -3.35212903736890,
        -3.76856746334183, -4.08038958119415, -2.76392831537264,
        -2.71029592325091, -2.39479802374318, -2.27624555654139,
        -2.56186893193166, -2.06441493580912, -2.23711174115767,
        -2.62633223976389, -1.96803655887235, -2.18633176952577,
        -4.94316580509435, -1.93826236105134, -1.97136890007696,
        -2.86399564907752, -3.29445777047943, -2.64207521857781,
        -4.56218497039310, -2.89873958804547, -2.56389678701749,
        -2.25412690944421, -5.14353158029202, -2.05513885592663,
        -3.46299960529256, -5.58500500690675, -2.45437742175553,
        -2.07564528952553, -2.00027586368516, -3.09538115196467,
        -4.84454675324070, -3.06707123886426, -2.63810900114140,
        -1.87607811044581, -7.41553897446514, -3.65715378011862,
        -2.48636212852611, -4.37448487047811, -5.10654068331531,
        -4.09357702077157, -2.52754693818062, -2.48977722616233,
        -2.05944824994645, -3.78187481133951, -1.89744540349888,
        -2.15370156889603, -2.78999439073233, -3.52627562703319,
        -2.37140544716903, -2.08998196088101, -2.31463368356231,
        -4.25567603775465, -1.90564505866691, -2.09811442317097,
        -4.91110288088148, -2.48274431727296, -4.36371489578988,
        -2.17737709289235, -2.93588184222901, -2.01887106861039,
        -4.88378683318971, -1.99315697014626, -2.26981158139869,
        -1.91416803924444, -6.01948462986551, -1.90648678405622,
        -2.29310025981196, -2.35692053770672, -1.86676509001724,
        -2.76233496909443, -2.31301896170926, -2.27429847127043,
        -1.93831223081587, -2.19173085657374, -5.07703883463966,
        -4.88376643587540, -2.80757242691160, -2.45805995019073,
        -2.88359387847497, -5.61829436823834, -1.84228827979812,
        -2.00560445563187, -2.54722133845364, -5.14134933576215,
        -3.07603290599309, -2.06748508133250, -2.56036670790042,
        -3.97222161900785, -2.74879080651652
    ]
  else:
    matlab_priors = [
        -2.75368898354517, -1.92464120661888, -3.12117495539684,
        -2.06976647699319, -2.55332377869746, -2.42545258730452,
        -1.82005387448326, -4.33273889191084, -1.98044632463670,
        -3.72259866140098, -2.13445092603297, -1.89861370330613,
        -2.44130748796840, -2.61657494283343, -2.36864595205851,
        -2.36508993497818, -1.97830818003985, -3.22648794961932,
        -1.88415799840830, -1.83258806669884, -1.83424935693299,
        -1.91285078800354, -2.30696504324797, -2.51068984374405,
        -2.78440095495691, -2.00086469675464, -2.37323387000985,
        -1.83936796156227, -4.67181582377101, -2.29252952771207,
        -1.89778293404691, -3.04233616777006, -2.03783502216447,
        -2.09242824658830, -4.28624077404921, -6.22984931522903,
        -2.56781371908942, -2.51450679828782, -2.75482205229398,
        -3.79829983176249, -3.36860777597950, -2.12840705709028,
        -2.91380477823819, -2.05862787270623, -2.11890275010214,
        -2.47044864823628, -2.10009709507196, -2.02444611020457,
        -4.62259634088628, -3.16658380792089, -2.62322263656332,
        -3.06006773067500, -2.89956211375636, -3.35497665799522,
        -2.18159107448637, -2.13313833251932, -2.89419940722966,
        -3.14624445974502, -2.08202622891124, -2.14528026929835,
        -1.81382635107188, -3.12438548847875, -1.87806467236171,
        -2.00029350507124, -2.02840436829997, -2.76757502046594,
        -3.46488511387572, -2.59957789483496, -2.17635936498238,
        -4.23286115251315, -2.11727447070024, -4.05360702217961,
        -2.90093751180728, -4.78100611786678, -3.71723903845173,
        -3.42775283434817, -3.52322013833705, -3.26205377998497,
        -2.53184873903622, -2.86832435891128, -2.04304914276147,
        -2.83690169847115, -4.16656546846068, -2.28556300378205,
        -1.83745830866259, -3.60716904810351, -1.99468206432150,
        -2.50299773204842, -3.54508373640091, -3.05739928612441,
        -3.48107044857412, -2.40351420635910, -1.87727473206462,
        -2.21713935371100, -3.26774051205353, -4.68506345009292,
        -3.44411735161459, -2.46558069267650, -1.97899405176218,
        -3.75970348821062, -1.97990375929309, -4.26819302742513,
        -4.27633057435657, -3.14956928568177, -2.50660370068346,
        -3.26723252565856, -1.87184242061923, -2.40327791653006,
        -2.07525963832372, -1.79218793223765, -2.41057384254973,
        -2.34050842014930, -1.97310630491761, -2.87650858804500,
        -2.42644923119400, -3.25708019374972, -2.81313400203567,
        -3.99606615421950, -3.81500733395832, -2.26350731828010,
        -2.01606712866596, -4.35178370935328, -1.92009810902642,
        -1.87535066707215, -3.83158113587802, -2.58474913211024,
        -1.95499573098142, -3.93178887080695, -2.41555310245392,
        -6.36350589883003, -2.04622420001362, -2.80068018621277,
        -2.37465744141935, -3.56884409636254, -1.91221108160123,
        -2.75938702981827, -3.49493208224428, -2.22046994655441,
        -4.33310838726566, -4.24744635992502, -4.31886144886988,
        -2.77504002417437, -3.80429572490482, -1.86641888647036,
        -3.30282719938917, -1.79035232123153, -2.08564803270937,
        -1.91492970639514, -3.36597316930867, -1.79125037546263,
        -3.31739677327310, -2.56147332427187, -3.17465047717430,
        -2.81806405365685, -2.60153910576706, -2.72385596595215,
        -2.52266568010086, -2.55284487894571, -4.76973460922123,
        -4.01530062286530, -3.47090748167667, -1.88223349793032,
        -1.85957879778571, -4.37888340267561, -1.79386961223242,
        -2.39681507759574, -1.95021920364178, -1.85232339701977,
        -2.02774875840056, -2.70767055352855, -2.12154826790298,
        -3.70842752893888, -2.67805109701825, -2.26418862824241,
        -2.21272950494345, -2.11588612968064, -1.92100022935749,
        -5.79175816524924, -2.41594870605519, -4.55927285522761,
        -2.25022489764182, -2.30950168099468, -2.98994865510133,
        -2.63289971079689, -2.42864327486276, -2.28075346814090,
        -1.94518692706826, -2.08589043568911, -2.83846785144893,
        -3.11646837024316, -5.56729576495567, -2.33325327272926,
        -2.02241119785581, -5.39416930285599, -2.91692334353624,
        -2.84886613589702, -4.47459351734034, -2.85038898625762,
        -3.07315347613061, -3.10406689475474
    ]
  all_priors = sample["Log Prior"]

  for indiv in range(len(matlab_priors)):  # 200
    prior_korali = all_priors[indiv]
    prior_matlab = matlab_priors[indiv]
    import pdb
    pdb.set_trace()
    if not (np.isclose(prior_korali, prior_matlab, rtol=1e-03, atol=1e-08)):
      import pdb
      pdb.set_trace()
      print(f" korali prior: {prior_korali}; matlab prior: {prior_matlab}")
      raise AssertionError(
          "Matlab-calculated Prior differed from Korali-calculated Prior.")


def populate_for_test_llh(sample):
  if sample["Current Generation"] == 1:
    z_1 = [[
        2.29617118400922, 3.20078291754841, 3.09017282673477, 1.64129677465403,
        1.87007236950973, 2.73373752377581, 2.12033157031684, 3.13633128468824,
        1.31322688128078, 2.47168286344277, 2.28834246545593, 3.39185483504681,
        0.654497989838905, 2.00074740619173, 2.05349480757377,
        -0.341905193911678, 3.24809514455416, 4.80923185356508,
        1.76781513822437, 2.28703214689339, 1.53539551010664, 2.38431777671226,
        1.62017247664669, 1.89822177245450, 3.61815114170313, 1.15277011735014,
        1.42411682328718, 1.92408687163145, 1.86752840782227, 3.43930966613682,
        4.03126291502474, 1.02179838994977, 1.35897633200762, 2.52047566951604,
        1.61930000384601, 3.99285194124338, 3.63587024814945, 2.55901889132950,
        2.56363758440702, 1.66160337867572, 2.76364737158536, 3.12744234603730,
        2.14157116726305, 3.92813410297015, 2.67063790955333, 1.88988876300060,
        2.37096225801191, 3.09659469334834, 1.60183689284492, 1.91453744871150,
        4.37328741115302, 1.52607898006474, 2.94634085841825, 2.81816157586699,
        3.58897088443884, 2.52601199721206, -0.465197552662072,
        1.14747205743548, 2.51173541276048, 2.25777491137441, 3.96244739500166,
        3.40631490892524, 2.49683373192458, 2.08283056227552, 0.451522135023551,
        3.86315963313024, 2.13402662181891, 0.453997426173788, 2.43328239619163,
        2.10295421998747, 1.42965390012336, 2.49306215669375, 1.29248678649202,
        0.651974964029148, 0.245698469063801, 1.63619104535263,
        1.37290599437388, 2.44015025271405, 0.497358871090851, 1.79176455565003,
        0.494874540416771, 3.80974082267486, 1.88302743224813, 3.22620898517007,
        2.49494314446408, 2.90859485435771, 0.845781165231419, 3.25755551743135,
        3.45253241673925, -0.0768114851631014, 1.82351199593344,
        1.34791780852425, 2.15653380369264, 1.14977420569265, 2.27904591870816,
        2.59709373050610, 2.24471670780635, 1.88165348892492, 0.710592118054841,
        2.05756364172883, 1.47906711272754, 0.720973108220354, 1.94377276849990,
        1.79031971682780, 2.19210155851939, 2.99233228899097, 2.57624419377870,
        3.30578377155815, 1.27069416813450, 1.13542531242176, 1.90507900859342,
        3.38321391556811, 3.30368137352944, 1.87418781944396, 1.40312621504398,
        0.479353674387140, 2.67184160066350, 2.02284429005612,
        0.822211413746046, 1.66542183590025, 0.170544791392103,
        2.42998959695220, 1.82600653768634, 3.63124241928948, 0.640571978569485,
        2.97050668196924, 2.14363981048730, 2.08260359115828, 2.71666401455796,
        3.19348386200520, 0.928938081253924, 3.31890220931254,
        0.789996858805363, 0.925885098226674, 1.32743991815706,
        2.73646218157545, 0.930039307199717, 2.33471511952614, 2.41188259525515,
        2.15412018753439, 2.55457069767033, 0.827154311543846, 3.00758668596220,
        2.11352028011021, 2.73005086744430, 1.01648821948116, 2.05203155671805,
        2.87759937259473, 3.01414104094213, 1.91565158921320, 0.146468423653789,
        0.903179290140671, 2.21862762752517, 2.79424585072032, 2.46312419493149,
        1.38736997577960, 4.24439981063933, 2.07234760835936, 2.86551439630275,
        1.58430353340430, 0.885061894073759, 2.68525242793293, 3.03767321527948,
        3.82221152843106, 1.47101150692324, 0.372033267004412, 3.61730243170781,
        2.26413674191525, 0.872853814340827, 1.44082414096478, 1.19115484346264,
        3.16100428559655, 2.59210526914654, 2.24274766448453, 2.24047748467937,
        1.17849960115298, 2.99311212621320, 2.34639472451811, 1.73886647263345,
        1.81528709491202, 1.89826500042124, 1.11295685617196, 2.74137709730535,
        3.39220787088793, 4.47390028937627, 2.50391924269087, 1.17751944616943,
        2.20098187064634, 0.992947472490921, 1.38682843976593, 1.34103660915048,
        1.16677067248804, 2.37817929688714, 0.884657403991827, 2.66724135174662,
        2.79533280366610, 3.03749185434765, 1.97956880739732, 2.61895308586923,
        3.80306351071647
    ],
           [
               2.05299331129256, 1.82210991316582, 3.77248256195541,
               -0.508803613080886, 1.54341081464077, 4.43037753693738,
               1.52854591410129, 1.43967150885168, 0.773532626236361,
               2.79295036359821, -0.109940431844270, 1.20060487399405,
               2.56697509289923, 1.99855710113744, 2.62392466625475,
               2.12644083103468, 2.68086779418754, 0.712584086139264,
               2.21808485252473, 0.433432926304198, 2.78328193083687,
               1.68943009127843, 2.65532441157286, 1.46253264032925,
               2.32864340325321, 3.05407197142897, 0.0203006808458179,
               0.132611815412811, 0.167644328974650, 2.84859211514014,
               2.40518726006168, 1.29754396343999, 3.49904602128464,
               2.13779486573036, 0.413178600096547, 0.980854485162359,
               0.614766258974073, 2.95488643030715, 1.39887968062904,
               0.828109195854724, 1.42288969290326, 1.16356947554693,
               2.85296953008717, 2.47733117867658, 2.30232007494690,
               2.41577619061790, 2.04297482930469, 1.05114676994282,
               2.54160836625546, 1.17887174128111, 0.928094951550908,
               0.925908363621740, 2.86955280731327, 2.98105141452526,
               0.241174630860989, 1.85190404243296, 2.25194174617539,
               1.38961537410717, 2.76097981021838, 2.25442950225039,
               1.84716632306262, 1.44258912479082, 2.67701765684745,
               2.84929744042206, 2.46930718258995, 1.76021829551074,
               2.92098545380990, 1.09311862159291, 2.14444060627547,
               3.39640902818180, 1.81030124039511, 1.15616410917400,
               3.94343804984731, 1.75307845942512, 2.44161915586591,
               1.19638851577964, 2.28760943270448, 2.46701809375390,
               2.00456160956192, 2.32609035860327, 3.20458671653349,
               0.595884167929142, 2.20556355545433, 0.00880421057792913,
               2.02840893391827, 3.93051540875233, 2.94113678832666,
               1.99307554869813, 1.66175835272769, 2.52826578368137,
               3.05689959434016, 2.01474061660244, 3.61476126691229,
               1.18414503814382, 0.00224087563347530, 1.25180859168525,
               1.80069597936153, 1.62723992202956, 1.15262883983521,
               3.33723804312817, 0.383682742052146, 1.50818240506843,
               1.03069843299257, 1.52589207947310, 1.33383617480591,
               2.47837468311500, 0.958941866987849, 1.17934090934243,
               2.10112960601311, 3.08398253686458, 0.145472762617027,
               3.79975278578809, 1.12162569442147, 2.64773272643321,
               3.04956503225249, 3.32309337684571, 1.48264103436202,
               2.02431494971106, 1.83763312644646, 1.39433891393262,
               2.27170976400902, 2.35864341217906, 1.64768487721931,
               2.13235992819972, 4.67358177719941, 1.99243392455546,
               2.71030293666139, 1.53746063718710, 1.47212209939989,
               1.65421293309550, 2.56455777373437, 1.19846085599792,
               0.147053214831775, 2.05321601745319, 1.56358478294511,
               2.28000747226616, 2.08460588718095, 2.72911905956814,
               2.90075309564583, 0.674361705468142, 0.475421171514989,
               2.50243333306286, 2.30639142564950, 1.06083953468134,
               3.23740212643015, 2.03301191455503, 2.12356831822123,
               2.27393937955077, 2.75416580828241, 3.52449750573379,
               1.73802423774430, 0.269316492227054, 3.01346429999008,
               1.07226390155370, 3.24368028622358, 1.41051130241411,
               3.49148173478654, 1.19402190528573, 0.887400947246797,
               2.95693956809938, 0.636948411062710, 2.68058496272415,
               2.43782362256573, 1.85673245332796, 1.65846749539944,
               4.05781063406419, 1.62546496457420, 1.80979680254716,
               1.06126758938830, 1.18653763561683, 1.41638124847140,
               3.70952537052387, 1.60958018222896, 1.30993463672020,
               1.55177929807091, 2.71437635009961, 0.684268751716891,
               2.62712209526315, 0.668705156739317, 1.86915184824033,
               0.173103829282035, 2.53592246511016, 2.69286471543664,
               1.31245024491926, 2.31757575644042, 2.16284234012427,
               3.15911590583064, 2.12838805866360, 3.03945813330173,
               1.88322885869547, 1.35170308989575, 1.96201879511236,
               1.80067518122789, 2.88166987201569, 1.94385592909307,
               1.15876113061260, 1.84515616191396, 3.18859467046427,
               1.58509272076415, 1.34138323748860
           ]]
  else:
    z_1 = [[
        2.51325987051297, 1.40878421503612, 2.60285829462683, 1.41679674221949,
        2.19339422281162, 0.608110621559598, 1.30971641436775,
        0.113261944312875, 1.22374876989320, 0.772471905969639,
        2.04878321492991, 1.16967809694040, 1.51375514809138, 2.64847830356440,
        2.17033301918522, 0.957647708648255, 1.25358355162573, 1.27833009032476,
        1.78085773323214, 1.54716152312401, 1.15444368975981, 0.976005052854044,
        1.51064856454261, 1.48613675061599, 0.790771169594314, 1.94863440693839,
        0.617871492355904, 1.10414809485583, 1.23010058877642, 1.63368521313434,
        1.76766338828680, 1.03442533106865, 0.871696656313525,
        0.833294147085729, 2.11446186091935, -1.33845438014709,
        1.85050324989325, 2.47630171180961, 0.274251058919018, 2.86076518918998,
        -0.334687260390733, 1.94115729945997, 2.07947794754501,
        0.742994629071168, 2.14933424658033, 2.01839733840656,
        0.926541718379551, 1.92501589774209, 3.47438843981508, 2.52981684619985,
        1.96350087214018, 0.740133230672934, 0.227384321059977,
        0.142617043135189, 2.13262730920509, 0.822593360443003,
        0.729231763471938, -0.0843520784392189, 1.34202896525380,
        1.58280715793526, 1.57224251716733, 0.611527512613638, 1.35984043725581,
        1.82460224784095, 1.49839407801028, 2.65166728312535, 1.24669302414795,
        2.62628680407843, 2.10300411067269, 0.496890404556512,
        0.631362238427303, 1.74224628001510, 2.22765809812510,
        0.900941943919266, 2.33066597055508, 1.54171928914225, 2.91053937231606,
        3.05987998685030, 0.235383755232049, 2.34609060170619, 1.41636042722212,
        0.417182102005065, -0.726803520280551, 2.36359833650414,
        1.19894307856614, 2.91276163321819, 1.93551603854067, 2.25507785013086,
        -0.396217045242703, 0.723502772625009, -0.259754583251015,
        1.11176046856458, 1.51991846739212, 1.47673850649039, 0.652594762011263,
        0.0805819618193975, 0.577009137248607, 0.586897016862015,
        1.08906633812686, 3.29180510155342, 1.08920599867229,
        -0.771901351231853, 0.614240814884296, -0.0352357101948864,
        0.226763958627970, 2.25843940735407, 1.73640978311785,
        0.347669055289415, 1.80958946941294, 1.30103331231147,
        0.305476112783863, 2.05184697499643, 0.801159690641492,
        0.361962287889785, 0.742435526561447, 0.190552267539491,
        1.01171302094188, -0.588206194481937, 0.386529195808807,
        2.30977023414513, 1.01777628915710, 1.87929204532346, 0.936747781911326,
        1.62264498465339, 0.281382225086359, 2.32940963144184,
        0.855948525093110, 1.01275104023632, 2.21059921539855,
        -0.692657298182765, 2.07869464819998, 0.217283876053494,
        1.67586554164771, -0.326575254771714, 1.08584125565231,
        2.04230518164526, 2.39286375437687, 1.42402705995727, 1.80708661502826,
        -0.134788404006370, -0.0656364191624916, 0.267998014424868,
        2.18451340510662, 1.72796867353584, 1.31662030244898, 1.47785415430068,
        2.07609959998850, 1.32771467843924, 1.27396143692859, 1.41401354716107,
        0.696837151711817, 2.15009487273058, 2.86299277198107, 1.65770814134549,
        1.10912349559289, 1.08990051187360, 1.29079196672076, 2.17107126632283,
        -0.826773321604854, 2.39386986615466, 1.20642002550224,
        1.07861432892296, 1.10155741418499, 3.24353121120897, 1.39930132931120,
        0.326738155650915, 1.08478062463738, 1.42829561328548, 2.05447954182443,
        0.412059660812047, 1.11636314032740, 0.489330858103160,
        2.37580721473181, 2.04281004990532, 0.498535178379248, 1.07646348762774,
        0.947150660804499, -0.732337628672538, 2.17020248170294,
        -0.704438559406450, 2.12208396853520, 0.905221897328984,
        0.0618381914566459, 2.60108267482984, 0.334487617377414,
        0.733000167383140, 1.92558323545780, 0.676266018040692,
        2.12638466523486, 2.33432790057397, 2.08455993336175, 1.24328379379015,
        0.775378811096715, 0.522931167993122, 2.35370539329238,
        0.289178820373317, -0.751427483756877, 0.181515858687299,
        -0.139042383004505, 2.90816707004314
    ],
           [
               3.15654550249467, 1.87942974080956, 3.42828230248396,
               3.12455905788443, 1.48679688684139, 3.16322165119004,
               2.15382434656399, 0.603485302999739, 2.97383414311329,
               4.20570087035203, 2.87369602483750, 1.98840527933309,
               1.28246383571818, 2.45513753730648, 1.68165552205360,
               1.43824386448780, 1.80447069458744, 0.741427577309199,
               2.20170856491113, 2.64446150350310, 2.57311474803492,
               2.64618444804771, 1.40386875670766, 1.22204031169584,
               1.15381466290258, 2.07536977270242, 1.67600796746383,
               2.51823933661647, 4.72697512275044, 1.44059742559655,
               2.65951221789689, 0.889252435471120, 1.93945220384215,
               2.90748464594216, 0.334510207964239, 3.37838295980004,
               3.52109080907736, 2.85221647045767, 1.62646593278021,
               3.68436457956391, 2.51940132274124, 1.79941483058382,
               1.09822180771236, 2.08698200876830, 2.63908792339358,
               3.34525650209449, 1.77749653824292, 2.80405812096062,
               1.36098415933903, 1.23698566701777, 3.51639517563147,
               0.980123948684885, 3.25909944272177, 3.58016421339226,
               1.93816187905809, 1.81555239854107, 1.10215020604482,
               1.76139355475220, 3.13878648701481, 3.19512478035522,
               2.24959935492560, 1.00247951991358, 1.97590492644254,
               1.92138276230329, 1.72159021376872, 1.85945130879489,
               4.17098756415373, 2.55552295897366, 1.90318883872180,
               4.35162931458960, 2.60635505218372, 4.43742909359891,
               3.58420501760915, 0.0577236359782440, 0.720609326535627,
               0.631700859976854, 1.39104634280501, 2.56254439427270,
               2.66134171894319, 3.46350381571992, 1.69367728022512,
               3.41158770444310, 2.54241765000761, 2.29889113592220,
               2.63323452787539, 3.46536975169648, 2.07124443520586,
               1.60380910750878, 2.02377870105303, 3.79301314730179,
               3.08677849515247, 1.34624103530735, 2.78703450182021,
               1.49068555612177, 3.89606100785423, 0.446853245102538,
               0.816165787651409, 3.19023962891733, 1.86946594066665,
               2.77670295591504, 1.86773131023205, 2.54156316731726,
               0.361115916380795, 1.65243480530229, 2.46107402680687,
               0.953844912685518, 2.17933856210626, 2.11526041939535,
               1.77817097063744, 2.43549947421727, 2.39369474177970,
               1.60391473438345, 2.34082482381483, 3.39393319391305,
               3.28065267472392, 1.23169174289951, 3.73453931319071,
               2.90870266152512, 4.07613208128819, 2.13042449089926,
               2.93382095509915, 4.54514604605463, 2.18089411708676,
               2.73274231225921, 4.01830696533407, 3.19270870956821,
               2.56499954909725, 4.37388419338160, 3.11852214005465,
               0.307954887237347, 2.23344712515267, 1.65560487247985,
               1.37252905376166, 1.73960263174999, 2.01252750484109,
               3.58655953215030, 0.891797544143462, 1.48391701408936,
               0.230826847487253, 3.92026650575602, 0.754358267195087,
               1.61070035018662, 4.18282272142655, 2.59229377318997,
               4.08691769615055, 2.37789998275099, 2.06983504454538,
               1.90207963280200, 0.663279488842439, 2.29930721319103,
               3.94768533908549, 3.34064468452754, 3.08443784818713,
               1.01645463205579, 3.60261716941131, 3.69067388265697,
               3.56945200843155, 1.46805035057192, 3.24855734864987,
               4.19012431446591, 4.17040588221371, 2.67785811191383,
               2.16120838918088, 1.16428500906458, 2.50893770778435,
               2.25098152895650, 2.85516908177054, 2.03960432238619,
               2.54105190420759, 3.27752103438151, 3.13916589916592,
               4.07439051379270, 3.24605969704421, 3.08917367800511,
               2.47653781979238, 1.66706401187562, 2.62682872937353,
               0.634352513184187, 1.62080499193831, 3.32054311539071,
               1.79870266547323, 3.25990801032968, 3.10615362546876,
               2.78089703090125, 2.08046308677928, 3.09961091933158,
               2.52959960496083, 2.16098572307766, 3.60079042793020,
               3.67324518590418, 4.98115848377507, 3.39928583698077,
               2.64631184527559, -0.0774386455212346, 1.28358687535554,
               1.49863539380702, 1.68216414997698, 3.13323688390174,
               2.69682002864984, 2.85125371325758
           ]]
  z_1 = np.array(z_1).transpose()
  sample["Latent Variables"] = [z.tolist() for z in z_1]


def test_llh(distrib, sample):
  ''' Compare to matlab evaluation '''
  data = np.array(distrib._p.data)
  all_llhs = sample["Log Likelihood"]

  all_latent_vars = sample["Latent Variables"]
  mean = sample["Mean"]
  cov = sample["Covariance Matrix"]

  if sample["Current Generation"] == 1:
    matlab_llhs = [
        -47.7698628979852, -4366.61266661045, -59.6194716163248,
        -5.81297491693852, -10.2679455191561, -8.51749743660197,
        -49.2835400896584, -7124.81987908238, -15.0059477185269,
        -28.6409341768081, -3314.36325413894, -33413.6655074425,
        -4.92649634216689, -10.2379899487411, -6.69243849301949,
        -7.29189090379427, -954.769754362861, -27106992.8905993,
        -3.75811395213427, -1127.18620256209, -3.74254166539663,
        -147.378731993211, -3.57501010351241, -14.9550466933386,
        -8848.13002911494, -4.28718227632267, -31.9444043674575,
        -208.485072040083, -97.9294992086003, -1509.15620589176,
        -40390.2801216493, -11.8817637758254, -4.45053961410038,
        -121.625149780702, -1.56636656142381, -597146.394059489,
        -292970.249670331, -31.4920641474235, -619.234290873034,
        -2.26031834705411, -1467.54553229187, -11998.8545862017,
        -7.49184954985934, -22999.5935710420, -176.535479570874,
        -5.01206213602500, -68.4050999312282, -13323.2376012807,
        -3.46057809424275, -23.6733765876322, -3063610.50408789,
        -3.70354329867405, -187.012859121887, -88.1194519242861,
        -510842.929413331, -217.360292471938, -6.62551779929136,
        -11.5432401672670, -36.6644406491725, -28.1690753350857,
        -93299.7056886475, -21842.8743127102, -39.3423286485044,
        -6.45571980203626, -5.20702447891414, -74446.2026140704,
        -7.11898231237097, -28.2461006419040, -79.2745583540211,
        -5.37636082403172, -3.50219672717272, -732.034510254699,
        -4.89295310214572, -11.5608660724265, -5.31091812054906,
        -2.75598584536886, -3.79578763692932, -42.7584357373062,
        -8.57991751993428, -4.20482159037998, -4.46970219823164,
        -614810.115366923, -5.03974363931120, -181922.932878807,
        -131.216520839205, -23.8119888509622, -4.53655585512686,
        -3909.64944781604, -17035.4142884105, -5.55423723106572,
        -4.24106234456871, -3.39158206837589, -5.41646112415913,
        -12.5946401200502, -2449.89750450518, -971.829501622365,
        -56.8546887461201, -7.90329381050810, -26.4542344767886,
        -5.14100176983953, -7.86992901523926, -11.9329109701573,
        -44.3363415899913, -7.65363532612725, -116.805556151774,
        -485.139707500205, -1603.12684357745, -24398.8175733644,
        -4.00432796896393, -4.27651284210303, -127.028463710500,
        -182.269392926832, -27272.8531999789, -4.27018465317510,
        -4.04125293566314, -4.62389489170062, -869.733358889152,
        -12.0139429671244, -8.69336101609780, -2.36786435181571,
        -6.13587763326668, -52.7743323621811, -5.77896015828338,
        -13774.4499558310, -5.61315880926991, -1156.65288255436,
        -9.30280573086852, -42.6719070381479, -1123.86557754761,
        -5916.61779627740, -4.19577696182872, -24760.7477539505,
        -132.927449228613, -6.30082235872278, -5.37264710139209,
        -235.380435287437, -5.82676618826780, -18.0389559382103,
        -19.1118020820321, -316.479666914072, -3725.03542023834,
        -4.60323990336629, -744.044796359678, -118.230465918386,
        -38.5344360907583, -5.74065250626685, -12.1292490003563,
        -456.994489553750, -311.849340587893, -4.66450689529431,
        -11.5430532820010, -95.3508170684135, -8.58284678076011,
        -3406.87413262191, -13.9420885701837, -3.87982808085096,
        -10843.7461241289, -69.5577613643428, -6736.22522613316,
        -3.87652670345407, -56.8095999419624, -88.7217991374164,
        -643.331058513594, -52004.8905228099, -3.72545548681157,
        -5.04816984879538, -35926.6022888848, -60.0652742831879,
        -25.7402446136764, -5.99808524243944, -8.14622938283796,
        -88.4470438836195, -456.704374117726, -157.262954880986,
        -91.6825576294440, -4.03994726556001, -17537.5686240544,
        -22.1059081453609, -8.99585147730466, -5.23992646501520,
        -194.885894013874, -4.40765924797667, -110.485042054930,
        -26758.3118843745, -285188.072475118, -104.784761615248,
        -4.25030058851660, -26.1847356963724, -4.38442569278528,
        -3.68954921783476, -7.47898808351811, -5.10376471809334,
        -120.701375544158, -4.25931541449467, -343.544837834587,
        -2889.29594776421, -2077.18502255042, -4.73691543925240,
        -561.952130889970, -134809.159787836
    ]
  else:
    matlab_llhs = [
        -18.7894850950601, -3.59057934692136, -16.9839670819855,
        -4.10021262409962, -84.7830747616620, -4.52023334948210,
        -3.90141503080366, -95.3562404369661, -4.12900302336333,
        -5.17023675457013, -5.85283259122190, -4.79460630322173,
        -3.22851626583507, -114.027401917156, -46.9293259542905,
        -11.6376734223763, -5.24597748856232, -17.9396593989726,
        -3.88110418354812, -3.57042637086379, -4.24541815219721,
        -4.43059060840150, -2.92687985235033, -2.63050845805227,
        -19.9252875535867, -6.95768883963678, -10.9550203503250,
        -4.12489464766489, -5.65329715236098, -2.49687487535175,
        -3.83191330477244, -23.1451192427462, -6.16094345567272,
        -4.34937985426801, -501.137090850252, -4.63998819216966,
        -4.56564886882944, -26.6606704278711, -14.1894473493527,
        -29.3152700346800, -5.68793200026721, -10.5115730922419,
        -85.8540409650747, -7.20867721089205, -10.1806248033178,
        -4.95520649129486, -8.42887648768684, -4.82983332390389,
        -34025.6051548346, -745.807325419464, -4.67755111666326,
        -34.8525337189869, -4.57974654014530, -4.71022270470492,
        -26.1828783967748, -7.59189428992000, -26.5398826615332,
        -12.9094029683690, -4.13108721005070, -4.11416261966412,
        -3.20667029937414, -32.8977662708673, -3.73427898704044,
        -4.95910346429514, -3.03664857768183, -382.955329537105,
        -5.10638049002056, -87.5229932124740, -23.0058809802039,
        -5.30678862095830, -4.78585891351278, -5.36046548272101,
        -5.89296153647497, -215.828092034990, -786.507312818720,
        -1.64021447981676, -2997.48521323539, -547.253659313629,
        -5.23838136720856, -8.11827901827702, -3.26341892242528,
        -4.61807904053727, -5.42889372317763, -41.5834067080770,
        -4.06967955639500, -53.3248735555065, -6.33958111326259,
        -86.1673819621710, -8.16175611634911, -4.83850723380709,
        -4.52293317660722, -7.77262319040898, -3.74296036168597,
        -3.25296687606238, -4.91107550524285, -129.854950566172,
        -53.0244560947840, -4.56500127261304, -6.39833890100960,
        -951.044234225478, -5.74588835286052, -5.20439061839005,
        -94.2514113716987, -10.0004252199364, -5.00900056475400,
        -308.848925920226, -3.41244211185933, -6.96560372529074,
        -5.16093579802586, -3.93954244123994, -5.90827513266093,
        -26.5999929724750, -4.86699110843636, -4.62784251204914,
        -4.48763193513857, -29.6000323582779, -4.74869490843086,
        -4.72758562510769, -5.08264295672223, -42.5420637945080,
        -4.27532272295073, -5.48464837055486, -5.37167881564271,
        -3.65186246792483, -5.02731054035507, -9.16939886283791,
        -4.29780479607661, -5.31092511579750, -7.64050631314979,
        -171.591771133992, -13.2727475957903, -13.2549955307843,
        -3.05802330496585, -13.0459542754994, -5.49215041840322,
        -4.89677251047624, -748.229633408430, -3.73416191920203,
        -56.6579574788104, -4.95527078972719, -75.4332030909340,
        -12.4466711944399, -5.46353570013340, -3.65733721850319,
        -5.02003170324612, -3.47618153510040, -14.8737195437915,
        -3.69151449628305, -21.4907993631846, -3.44046142081076,
        -4.95096990107733, -5.80609542377596, -88.5994414398990,
        -2.05085785941888, -4.60882077075263, -4.67423546308292,
        -4.54896178439521, -74.4289459074090, -4.68573650269894,
        -6.15631001774948, -5.11470769458339, -4.19430111178733,
        -4.85909616473324, -19492.1639000473, -3.79200528140026,
        -5.86410187666240, -4.19590155856393, -3.76705709681814,
        -7.31202071274772, -4.63064527016554, -4.28519671891203,
        -5.08604330762594, -10.0396171556389, -5.35307021688591,
        -5.19297408869240, -6.90238292453462, -4.59375499542089,
        -86.9265702816188, -55.1298710666853, -4.58886283045279,
        -35.0161271974321, -4.49101049687920, -4.57300019045377,
        -51.1352665267768, -7.00152372334117, -4.47620840476402,
        -5.08290458241975, -5.89451293710359, -5.23237969193701,
        -6.74847731864578, -5.93337234887605, -4.41677470511263,
        -4.43644635728360, -236.974423732959, -284.352919955193,
        -16.8299429137284, -15.1643567791076, -4.58828630418912,
        -4.95680034665398, -161.446313097983
    ]

  for indiv in range(len(data)):
    llh_korali = all_llhs[indiv]
    llh_matlab = matlab_llhs[indiv]
    if not (np.isclose(llh_korali, llh_matlab, rtol=1e-03, atol=1e-08)):
      import pdb
      pdb.set_trace()
      print(f"korali-llh: {llh_korali}; matlab-llh: {llh_matlab}")
      raise AssertionError(
          "Matlab-calculated LLH differed from Korali-calculated LLH.")


def test_function(distrib, sample):
  all_latent_vars = sample["Latent Variables"]
  mean = sample["Mean"]
  cov = sample["Covariance Matrix"]
  all_llhs = sample["Log Likelihood"]
  logn_ids = [0, 1]
  logitn_ids = []

  import scipy.stats

  data = np.array(distrib._p.data
                 )  # 200 x 1 x 3 -- last dimension contains: (id , x==0 , y)

  for indiv in range(len(data)):
    llh_korali = all_llhs[indiv]
    latents = all_latent_vars[indiv]
    latents = transform_from_z_by_ids(latents, logn_ids, logitn_ids)
    llh = 0
    for point in data[indiv]:
      fx = normalModel(point[1], latents[0])
      llh_point = scipy.stats.norm.logpdf(point[2], fx, scale=latents[1])
      llh += llh_point
    assert np.isclose(llh_korali, llh)


def main():
  # Initialize the distribution
  distrib = NormalConditionalDistribution()

  k = korali.Engine()
  e = korali.Experiment()

  e["Problem"]["Type"] = "Bayesian/Latent/HierarchicalLatentCustom"
  # The computational model for the log-likelihood, log[ p(data point | latent) ]
  e["Problem"][
      "Conditional Log Likelihood Function"] = lambda sample: distrib.conditional_p(
          sample)

  data_vector = [[] for _ in range(distrib._p.nIndividuals)]
  for i in range(distrib._p.nIndividuals):
    data_vector[i] = distrib._p.data[i].tolist()
  e["Problem"]["Data"] = data_vector
  e["Problem"]["Data Dimensions"] = distrib._p.nDataDimensions
  e["Problem"]["Number Individuals"] = distrib._p.nIndividuals
  e["Problem"]["Latent Space Dimensions"] = distrib._p.nLatentSpaceDimensions

  e["Solver"]["Type"] = "Executor2"
  e["Solver"]["Executions Per Generation"] = 1

  # *** Choose one:
  test_what = "prior"
  # test_what = "llh"
  if test_what == "prior":
    e["Solver"]["Vector Result Names"] = ["Log Prior"]
    e["Solver"]["Function To Execute"] = "Evaluate logPrior"
    e["Solver"][
        "Function To Populate Sample Parameters"] = lambda sample: populate_for_test_prior(
            sample)
    e["Solver"]["Test Function"] = lambda sample: test_prior(sample)
  else:
    assert test_what == "llh"
    e["Solver"]["Vector Result Names"] = ["Log Likelihood"]
    e["Solver"]["Function To Execute"] = "Evaluate logLikelihood"
    e["Solver"][
        "Function To Populate Sample Parameters"] = lambda sample: populate_for_test_llh(
            sample)
    e["Solver"]["Test Function"] = lambda sample: test_llh(distrib, sample)

  parmap1 = {}
  parmap2 = {}
  parmap1["Mean"] = [0., 1.]
  # The latents are assumed to already be in z-form, that is, log(latent)
  parmap2["Latent Variables"] = [[0.0, 1.1]] * distrib._p.nIndividuals
  parmap2["Covariance Matrix"] = [[1.0, 0.0], [0., 1.]]
  e["Solver"]["Vector Parameters"] = parmap1
  e["Solver"]["Vector Of Vectors Parameters"] = parmap2
  e["Solver"]["Termination Criteria"]["Max Generations"] = 10
  e["Solver"]["Termination Criteria"]["Max Model Evaluations"] = 100

  e["Distributions"][0]["Name"] = "Uniform 0"
  e["Distributions"][0]["Type"] = "Univariate/Uniform"
  e["Distributions"][0]["Minimum"] = -100
  e["Distributions"][0]["Maximum"] = 100

  e["Distributions"][1]["Name"] = "Uniform 1"
  e["Distributions"][1]["Type"] = "Univariate/Uniform"
  e["Distributions"][1]["Minimum"] = 0
  e["Distributions"][1]["Maximum"] = 100

  e["Distributions"][2]["Name"] = "Uniform 2"
  e["Distributions"][2]["Type"] = "Univariate/Uniform"
  e["Distributions"][2]["Minimum"] = 0.0
  e["Distributions"][2]["Maximum"] = 1.0

  # * Define the variables:
  #   We only define one prototype latent variable vector for individual 0.
  #   The others will be automatically generated by Korali, as well as all hyperparameters.
  if np.isscalar(distrib._p.transf):
    distrib._p.transf = [distrib._p.transf]
  if np.isscalar(distrib._p.err_transf):
    distrib._p.err_transf = [distrib._p.err_transf]
  dimCounter = 0
  distribs = {
      "Normal": "Uniform 0",
      "Log-Normal": "Uniform 1",
      "Logit-Normal": "Uniform 2",
      "Probit-Normal": "Uniform XX"
  }
  for transf in distrib._p.transf:
    generate_variable(
        transf,
        e,
        dimCounter,
        "latent parameter " + str(dimCounter),
        distribs,
        initial=distrib._p.beta[dimCounter])
    dimCounter += 1

  for i, err_transf in enumerate(distrib._p.err_transf):
    generate_variable(
        err_transf,
        e,
        dimCounter,
        "standard deviation " + str(i),
        distribs,
        initial=distrib._p.beta[dimCounter])
    dimCounter += 1

  assert dimCounter == distrib._p.dNormal + distrib._p.dLognormal + distrib._p.dLogitnormal + distrib._p.dProbitnormal

  e["File Output"]["Frequency"] = 1
  e["Console Output"]["Frequency"] = 1
  e["Console Output"]["Verbosity"] = "Normal"

  k.run(e)


if __name__ == '__main__':
  # ** For debugging, try this: **
  import sys, trace
  sys.stdout = sys.stderr
  tracer = trace.Trace(trace=1, count=0, ignoredirs=["/usr", sys.prefix])
  tracer.runfunc(main)
  # ** Else: **
  # main()
